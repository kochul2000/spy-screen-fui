<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CIA :: ARGUS NETWORK v7.4.1</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap');

  :root {
    --bg: #060a10;
    --panel: rgba(8, 18, 32, 0.85);
    --border: rgba(40, 120, 200, 0.2);
    --border-bright: rgba(40, 120, 200, 0.5);
    --accent: #1e90ff;
    --accent-dim: rgba(30, 144, 255, 0.15);
    --accent-glow: rgba(30, 144, 255, 0.4);
    --green: #00e676;
    --green-dim: rgba(0, 230, 118, 0.15);
    --red: #ff3d3d;
    --red-dim: rgba(255, 61, 61, 0.15);
    --amber: #ffab00;
    --amber-dim: rgba(255, 171, 0, 0.15);
    --text: #c8d8ec;
    --text-dim: #4a6080;
    --text-bright: #e8f0ff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
    cursor: default;
    user-select: none;
  }

  /* Show cursor only on input */
  .comms-input { cursor: text !important; }

  /* Scanlines ‚Äî will-change promotes to own compositing layer (GPU) */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent 0px, transparent 2px, rgba(30,144,255,0.015) 2px, rgba(30,144,255,0.015) 4px);
    pointer-events: none;
    z-index: 9999;
    will-change: transform;
  }

  /* Vignette */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.5) 100%);
    pointer-events: none;
    z-index: 9998;
    will-change: transform;
  }

  /* TOP BAR */
  .top-bar {
    height: 36px;
    background: linear-gradient(90deg, rgba(180,0,0,0.2), rgba(180,0,0,0.05) 30%, rgba(180,0,0,0.05) 70%, rgba(180,0,0,0.2));
    border-bottom: 1px solid rgba(255,50,50,0.25);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 2.5px;
    color: var(--red);
  }

  .top-bar .blink-dot {
    width: 6px; height: 6px;
    background: var(--red);
    border-radius: 50%;
    display: inline-block;
    margin-right: 10px;
    animation: blink 1s infinite;
  }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.15} }

  .top-bar .classification { text-transform: uppercase; }
  .top-bar .sys-id { color: rgba(255,80,80,0.6); font-size: 10px; }

  /* MAIN GRID */
  .main-grid {
    display: grid;
    grid-template-columns: clamp(180px, 18vw, 280px) 1fr clamp(200px, 19vw, 300px);
    grid-template-rows: 1fr;
    height: calc(100vh - 36px - 28px);
    gap: 1px;
  }

  /* LEFT PANEL */
  .left-panel {
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .panel-header {
    padding: 10px 14px;
    font-family: 'Orbitron', sans-serif;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--accent);
    border-bottom: 1px solid var(--border);
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-header .indicator {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
  }

  /* Agent list */
  .agent-list { flex: 1; overflow: hidden; padding: 6px 0; }

  .agent-item {
    padding: 8px 14px;
    border-bottom: 1px solid rgba(40,120,200,0.08);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    transition: background 0.3s;
  }

  .agent-item.agent-focus { background: var(--accent-dim); border-left: 2px solid var(--accent); }
  .agent-item.agent-linked .status-dot { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  .agent-item.agent-linked .agent-code { color: var(--accent); }

  .agent-item .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .status-active { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-standby { background: var(--amber); box-shadow: 0 0 6px var(--amber); }
  .status-dark { background: var(--red); box-shadow: 0 0 4px var(--red); animation: blink 2s infinite; }
  .status-offline { background: #444; }

  .agent-info { flex: 1; }
  .agent-code { font-family: 'Share Tech Mono', monospace; color: var(--text-bright); font-size: 13px; }
  .agent-loc { color: var(--text-dim); font-size: 10px; letter-spacing: 1px; font-family: 'Share Tech Mono', monospace; }
  .agent-role { font-size: 10px; color: var(--text-dim); }

  /* CENTER */
  .center-panel {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .center-top {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr clamp(200px, 35%, 500px);
    gap: 1px;
    min-height: 0;
  }

  /* Map area */
  .map-container {
    background: var(--panel);
    position: relative;
    overflow: hidden;
    border-right: 1px solid var(--border);
  }

  .map-title {
    position: absolute;
    top: 10px; left: 14px;
    font-family: 'Orbitron', sans-serif;
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--accent);
    z-index: 10;
    text-transform: uppercase;
  }

  .map-canvas { width: 100%; height: 100%; }

  /* Surveillance feed */
  .surveil-container {
    background: var(--panel);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .surveil-header {
    padding: 8px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--red);
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid var(--border);
    letter-spacing: 1.5px;
  }

  .surveil-grid {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 1px;
    background: rgba(0,0,0,0.3);
  }

  .cam-feed {
    background: #0a0e14;
    position: relative;
    overflow: hidden;
  }

  .cam-feed canvas { width: 100%; height: 100%; }

  .cam-label {
    position: absolute;
    bottom: 6px; left: 8px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 9px;
    color: rgba(255,255,255,0.5);
    letter-spacing: 1px;
  }

  .cam-rec {
    position: absolute;
    top: 6px; right: 8px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 9px;
    color: var(--red);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .cam-rec::before {
    content: '';
    width: 5px; height: 5px;
    background: var(--red);
    border-radius: 50%;
    animation: blink 1s infinite;
  }

  /* Center bottom data feed */
  .center-bottom {
    height: 300px;
    border-top: 1px solid var(--border);
    background: var(--panel);
    display: flex;
    flex-direction: column;
  }

  .data-header {
    padding: 6px 14px;
    font-family: 'Orbitron', sans-serif;
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--accent);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .data-feed {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 8px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    line-height: 1.7;
    color: var(--text-dim);
  }

  .data-feed::-webkit-scrollbar { width: 3px; }
  .data-feed::-webkit-scrollbar-track { background: transparent; }
  .data-feed::-webkit-scrollbar-thumb { background: var(--border-bright); }

  .data-feed .highlight { color: var(--green); }
  .data-feed .warn { color: var(--amber); }
  .data-feed .alert { color: var(--red); }
  .data-feed .info { color: var(--accent); }

  /* RIGHT PANEL */
  .right-panel {
    background: var(--panel);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Target profile */
  .target-section {
    padding: 14px;
    border-bottom: 1px solid var(--border);
  }

  .target-photo {
    width: 100%;
    height: 140px;
    background: linear-gradient(135deg, #0a1525 0%, #0f2035 100%);
    border: 1px solid var(--border);
    margin-bottom: 10px;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .target-photo canvas { width: 100%; height: 100%; }

  .target-label {
    position: absolute;
    bottom: 6px; left: 8px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 8px;
    color: var(--red);
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  .target-meta {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    line-height: 2;
  }

  .target-meta .label { color: var(--text-dim); }
  .target-meta .value { color: var(--text-bright); }
  .target-meta .threat { color: var(--red); font-weight: bold; }

  /* Comms */
  .comms-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .comms-log {
    flex: 1;
    padding: 8px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    line-height: 1.8;
    overflow-y: auto;
    overflow-x: hidden;
    color: var(--text-dim);
    scroll-behavior: smooth;
  }

  .comms-log::-webkit-scrollbar { width: 3px; }
  .comms-log::-webkit-scrollbar-track { background: transparent; }
  .comms-log::-webkit-scrollbar-thumb { background: var(--border-bright); }

  .comms-log .ts { color: var(--text-dim); }
  .comms-log .src { color: var(--accent); }
  .comms-log .msg { color: var(--text); }
  .comms-log .encrypted { color: var(--amber); font-style: italic; }

  /* Comms input */
  .comms-input-wrap {
    display: flex;
    align-items: center;
    padding: 0 14px;
    height: 32px;
    border-top: 1px solid var(--border);
    background: rgba(0,0,0,0.3);
    gap: 8px;
    flex-shrink: 0;
  }

  .comms-input-prefix {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--green);
    white-space: nowrap;
    letter-spacing: 1px;
  }

  .comms-input {
    flex: 1;
    min-width: 0;
    background: transparent;
    border: none;
    outline: none;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-bright);
    caret-color: var(--green);
    letter-spacing: 0.5px;
  }

  .comms-input::placeholder {
    color: var(--text-dim);
    font-style: italic;
  }

  /* Signal bars */
  .signal-section {
    height: 80px;
    border-top: 1px solid var(--border);
    padding: 8px 14px;
  }

  .signal-section canvas { width: 100%; height: 100%; }

  /* BOTTOM BAR */
  .bottom-bar {
    height: 28px;
    background: var(--panel);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 1px;
  }

  .bottom-bar .net-status { color: var(--green); }
  .bottom-bar .encryption { color: var(--accent); }
  .clock { color: var(--text-bright); font-family: 'Orbitron', sans-serif; font-size: 11px; letter-spacing: 2px; }

  /* Glitch effect - occasional */
  @keyframes glitch {
    0%, 95%, 100% { transform: none; filter: none; }
    96% { transform: translate(-2px, 1px); filter: hue-rotate(90deg); }
    97% { transform: translate(2px, -1px); filter: hue-rotate(-90deg); }
    98% { transform: translate(-1px, -1px); filter: hue-rotate(45deg); }
  }

  .glitch-target {
    animation: glitch 12s infinite;
  }

  /* Grid lines animation for map */
  @keyframes sweep {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Pulse ring */
  @keyframes pulseRing {
    0% { transform: scale(1); opacity: 0.6; }
    100% { transform: scale(3); opacity: 0; }
  }

  .fullscreen-hint {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    color: rgba(200,216,236,0.3);
    letter-spacing: 2px;
    z-index: 10000;
    animation: fadeOut 4s forwards 3s;
  }

  @keyframes fadeOut { to { opacity: 0; } }

  /* MAP ALERT OVERLAY */
  .map-alert-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 20;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .map-alert-overlay.active { opacity: 1; }

  .map-alert-box {
    border: 2px solid var(--red);
    background: rgba(255,20,20,0.08);
    padding: 12px 30px;
    text-align: center;
    animation: alertPulse 0.6s infinite;
  }

  @keyframes alertPulse {
    0%,100% { border-color: rgba(255,61,61,0.9); box-shadow: 0 0 30px rgba(255,0,0,0.15); }
    50% { border-color: rgba(255,61,61,0.3); box-shadow: 0 0 10px rgba(255,0,0,0.05); }
  }

  .map-alert-box .alert-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 16px;
    font-weight: 900;
    color: var(--red);
    letter-spacing: 4px;
    margin-bottom: 4px;
  }

  .map-alert-box .alert-detail {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: rgba(255,150,150,0.8);
    letter-spacing: 1px;
  }

  /* Full screen flash */
  .screen-flash {
    position: fixed;
    inset: 0;
    background: rgba(255,30,30,0.06);
    pointer-events: none;
    z-index: 9997;
    opacity: 0;
    transition: opacity 0.1s;
  }

  .screen-flash.active {
    opacity: 1;
    animation: screenFlash 0.8s ease-out forwards;
  }

  /* Slash command hint overlay */
  .cmd-hint-overlay {
    position: fixed;
    bottom: 42px;
    right: 14px;
    background: rgba(6,10,16,0.95);
    border: 1px solid rgba(30,144,255,0.4);
    padding: 0;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    z-index: 10001;
    min-width: 260px;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.15s, transform 0.15s;
    pointer-events: none;
  }
  .cmd-hint-overlay.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .cmd-hint-title {
    padding: 6px 12px;
    color: var(--accent);
    font-family: 'Orbitron', sans-serif;
    font-size: 9px;
    letter-spacing: 2px;
    border-bottom: 1px solid rgba(30,144,255,0.2);
  }
  .cmd-hint-item {
    padding: 5px 12px;
    display: flex;
    gap: 12px;
    border-bottom: 1px solid rgba(30,144,255,0.06);
    color: var(--text-dim);
  }
  .cmd-hint-item:last-child { border-bottom: none; }
  .cmd-hint-item .cmd-key {
    color: var(--green);
    min-width: 60px;
    flex-shrink: 0;
  }
  .cmd-hint-item .cmd-desc { color: var(--text); }
  .cmd-hint-item.active-cmd { background: var(--accent-dim); }
  .cmd-hint-item.active-cmd .cmd-key { color: var(--amber); }
  .cmd-hint-item.cmd-selected { background: rgba(30,144,255,0.12); }
  .cmd-hint-item.cmd-selected .cmd-key { color: var(--text-bright); }

  @keyframes screenFlash {
    0% { opacity: 1; }
    100% { opacity: 0; }
  }

  /* Peer confirm overlay */
  .peer-confirm {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10002;
    background: rgba(0,0,0,0.6);
  }
  .peer-confirm-box {
    border: 2px solid var(--amber);
    background: rgba(6,10,16,0.95);
    padding: 20px 40px;
    text-align: center;
    animation: alertPulse 0.6s infinite;
    border-color: var(--amber);
  }
  .peer-confirm-box .pc-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--amber);
    letter-spacing: 3px;
    margin-bottom: 8px;
  }
  .peer-confirm-box .pc-id {
    font-family: 'Share Tech Mono', monospace;
    font-size: 18px;
    color: var(--text-bright);
    letter-spacing: 4px;
    margin-bottom: 16px;
  }
  .peer-confirm-box .pc-buttons {
    display: flex;
    gap: 16px;
    justify-content: center;
  }
  .peer-confirm-box .pc-btn {
    font-family: 'Orbitron', sans-serif;
    font-size: 11px;
    letter-spacing: 2px;
    padding: 8px 24px;
    border: 1px solid;
    background: transparent;
    cursor: pointer;
    transition: background 0.2s;
  }
  .pc-btn.accept { color: var(--green); border-color: var(--green); }
  .pc-btn.accept:hover { background: var(--green-dim); }
  .pc-btn.reject { color: var(--red); border-color: var(--red); }
  .pc-btn.reject:hover { background: var(--red-dim); }
</style>
</head>
<body>

<!-- TOP CLASSIFICATION BAR -->
<div class="top-bar">
  <div>
    <span class="blink-dot"></span>
    <span class="classification">TOP SECRET // SI // NOFORN // ARGUS</span>
  </div>
  <div class="sys-id">CIA-ARGUS-NET // NODE 7-ALPHA // NSA-RELAY ACTIVE</div>
</div>

<!-- MAIN GRID -->
<div class="main-grid">

  <!-- LEFT: Agent roster -->
  <div class="left-panel">
    <div class="panel-header">
      <span class="indicator"></span>
      FIELD OPERATIVES ‚Äî ACTIVE
    </div>
    <div class="agent-list" id="agentList"></div>
  </div>

  <!-- CENTER -->
  <div class="center-panel">
    <div class="center-top">
      <!-- Map -->
      <div class="map-container">
        <div class="map-title">GLOBAL TRACKING ‚Äî LIVE FEED</div>
        <canvas class="map-canvas" id="mapCanvas"></canvas>
        <div class="map-alert-overlay" id="mapAlertOverlay">
          <div class="map-alert-box">
            <div class="alert-title" id="mapAlertTitle">‚ö† PRIORITY ALERT</div>
            <div class="alert-detail" id="mapAlertDetail">UNIDENTIFIED CONTACT ‚Äî SECTOR 7</div>
          </div>
        </div>
      </div>
      <!-- Radar -->
      <div class="surveil-container">
        <div class="surveil-header">
          <span class="blink-dot" style="background:var(--green)"></span>
          RADAR ‚Äî PROXIMITY SCAN
        </div>
        <div style="flex:1;position:relative;overflow:hidden;">
          <canvas id="radarCanvas" style="width:100%;height:100%;"></canvas>
        </div>
      </div>
    </div>
    <!-- Encrypted Comms + Input -->
    <div class="center-bottom">
      <div class="data-header">
        <span style="color:var(--amber)">‚óè ENCRYPTED COMMS</span>
      </div>
      <div class="comms-log" id="commsLog"></div>
      <div class="comms-input-wrap">
        <span class="comms-input-prefix">OPERATOR &gt;</span>
        <input type="text" id="commsInput" class="comms-input" autocomplete="off" spellcheck="false" placeholder="Type anything ‚Äî auto-fill active  [/help]" />
      </div>
    </div>
  </div>

  <!-- RIGHT: Target + Comms -->
  <div class="right-panel">
    <div class="panel-header">
      <span class="indicator" style="background:var(--red);box-shadow:0 0 6px var(--red)"></span>
      PRIMARY TARGET
    </div>
    <div class="target-section">
      <div class="target-photo glitch-target">
        <canvas id="targetCanvas"></canvas>
        <div class="target-label">‚ö† THREAT LEVEL: CRITICAL</div>
      </div>
      <div class="target-meta">
        <div><span class="label">ALIAS: </span><span class="value">PROMETHEUS</span></div>
        <div><span class="label">REAL: </span><span class="value">[REDACTED]</span></div>
        <div><span class="label">NATION: </span><span class="value">UNKNOWN</span></div>
        <div><span class="label">STATUS: </span><span class="threat">AT LARGE</span></div>
        <div><span class="label">LAST SEEN: </span><span class="value">48¬∞12'N 16¬∞22'E</span></div>
        <div><span class="label">THREAT: </span><span class="threat">‚ñà‚ñà‚ñà‚ñà‚ñà CRITICAL</span></div>
      </div>
    </div>
    <div class="comms-section">
      <div class="panel-header">
        <span class="indicator" style="background:var(--green);box-shadow:0 0 6px var(--green)"></span>
        SIGINT INTERCEPT LOG
      </div>
      <div class="data-feed" id="dataFeed"></div>
    </div>
    <div class="signal-section">
      <canvas id="signalCanvas"></canvas>
    </div>
  </div>

</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar">
  <div><span class="net-status">‚óè NETWORK SECURE</span> &nbsp; AES-256-GCM &nbsp; <span class="encryption">ENCRYPTION LEVEL 5</span></div>
  <div id="peerStatus"><span style="color:var(--text-dim)">‚óã LINK OFF</span></div>
  <div class="clock" id="clock"></div>
</div>

<div class="fullscreen-hint">F11 FOR FULLSCREEN</div>
<div class="screen-flash" id="screenFlash"></div>
<div class="peer-confirm" id="peerConfirmOverlay" onclick="event.stopPropagation()">
  <div class="peer-confirm-box">
    <div class="pc-title">‚ö° INCOMING CONNECTION</div>
    <div class="pc-id">PEER: <span id="peerConfirmId">------</span></div>
    <div class="pc-buttons">
      <button class="pc-btn accept" id="peerAcceptBtn">ACCEPT</button>
      <button class="pc-btn reject" id="peerRejectBtn">REJECT</button>
    </div>
  </div>
</div>
<div class="peer-confirm" id="roomCodeOverlay" onclick="event.stopPropagation()">
  <div class="peer-confirm-box" style="border-color:var(--green)">
    <div class="pc-title" style="color:var(--green)">LINK ACTIVE</div>
    <div class="pc-id">ROOM: <span id="roomCodeDisplay" style="color:var(--amber)">------</span></div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-bottom:14px;letter-spacing:1px">Share this code with your peer</div>
    <div class="pc-buttons">
      <button class="pc-btn accept" id="roomCodeOkBtn">CONFIRM</button>
    </div>
  </div>
</div>
<div class="cmd-hint-overlay" id="cmdHint">
  <div class="cmd-hint-title">OPERATOR COMMANDS</div>
  <div class="cmd-hint-item active-cmd"><span class="cmd-key">/auto-type</span><span class="cmd-desc">Toggle auto-type <span style="opacity:0.4">on / off</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/auto-event</span><span class="cmd-desc">Toggle auto events <span style="opacity:0.4">on / off</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/sound</span><span class="cmd-desc">Toggle audio <span style="opacity:0.4">on / off</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/auto-comms</span><span class="cmd-desc">Toggle dummy comms <span style="opacity:0.4">on / off</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/name</span><span class="cmd-desc">Set callsign (/name PAPA)</span></div>
  <div class="cmd-hint-item" style="border-top:1px solid rgba(30,144,255,0.15)"><span class="cmd-key">/1</span><span class="cmd-desc">Red alert <span style="opacity:0.4">(Ctrl+1)</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/2</span><span class="cmd-desc">Explosion <span style="opacity:0.4">(Ctrl+2)</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/3</span><span class="cmd-desc">Target lock <span style="opacity:0.4">(Ctrl+3)</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/4</span><span class="cmd-desc">Incoming comms <span style="opacity:0.4">(Ctrl+4)</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/5</span><span class="cmd-desc">Data burst <span style="opacity:0.4">(Ctrl+5)</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/6</span><span class="cmd-desc">Security breach <span style="opacity:0.4">(Ctrl+6)</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/7</span><span class="cmd-desc">Satellite uplink <span style="opacity:0.4">(Ctrl+7)</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/8</span><span class="cmd-desc">Extraction <span style="opacity:0.4">(Ctrl+8)</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/9</span><span class="cmd-desc">Countdown <span style="opacity:0.4">(Ctrl+9)</span></span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/0</span><span class="cmd-desc">System scan <span style="opacity:0.4">(Ctrl+0)</span></span></div>
  <div class="cmd-hint-item" style="border-top:1px solid rgba(30,144,255,0.15)"><span class="cmd-key">/link</span><span class="cmd-desc">P2P on¬∑off¬∑connect (/link 774219)</span></div>
  <div class="cmd-hint-item"><span class="cmd-key">/link-slot</span><span class="cmd-desc">Set max peers (/link-slot 2)</span></div>
</div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
// ============= CLOCK =============
function updateClock() {
  const now = new Date();
  const h = String(now.getUTCHours()).padStart(2,'0');
  const m = String(now.getUTCMinutes()).padStart(2,'0');
  const s = String(now.getUTCSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `${h}:${m}:${s} UTC`;
}
setInterval(updateClock, 1000);
updateClock();

// ============= AGENTS =============
const agents = [
  { code: '001', name: 'AEGIS', loc: 'BERLIN, DE', status: 'active', role: 'FIELD OPS', x: 0.50, y: 0.20 },
  { code: '003', name: 'COBRA', loc: 'KARACHI, PK', status: 'standby', role: 'INTEL', x: 0.61, y: 0.28 },
  { code: 'PP', name: 'PAPA', loc: 'VIENNA, AT', status: 'active', role: 'FIELD OPS' },
  { code: '008', name: 'ARGENT', loc: 'UNKNOWN', status: 'dark', role: 'DEEP COVER' },
  { code: '004', name: 'FALCON', loc: 'TANGIER, MA', status: 'active', role: 'SURVEILLANCE', x: 0.46, y: 0.30 },
  { code: '009', name: 'SPECTRE', loc: 'MACAU, CN', status: 'active', role: 'FIELD OPS', x: 0.78, y: 0.28 },
  { code: '002', name: 'PHOENIX', loc: 'ISTANBUL, TR', status: 'standby', role: 'EXTRACTION', x: 0.52, y: 0.22 },
  { code: '006', name: 'TREVELYAN', loc: 'SIGNAL LOST', status: 'dark', role: 'UNKNOWN' },
  { code: '005', name: 'RAVEN', loc: 'MOSCOW, RU', status: 'active', role: 'INTEL', x: 0.58, y: 0.20 },
  { code: '0011', name: 'GHOST', loc: 'PYONGYANG, KP', status: 'offline', role: 'DEEP COVER', x: 0.74, y: 0.22 },
  { code: '0012', name: 'ORACLE', loc: 'LANGLEY, US', status: 'active', role: 'ANALYST', x: 0.24, y: 0.28, hq: true },
  { code: '0010', name: 'SHADOW', loc: 'TEHRAN, IR', status: 'standby', role: 'INTEL', x: 0.59, y: 0.27 },
];

const satellites = [
  { id: 'OVERWATCH-3', incl: 0.35, period: 108000, phase: 0,    color: [100,200,255] },
  { id: 'KEYHOLE-9',   incl: 0.20, period: 144000, phase: 1.2,  color: [255,180,60]  },
  { id: 'SIGINT-7',    incl: 0.28, period: 90000,  phase: 2.8,  color: [180,255,120] },
];

const agentListEl = document.getElementById('agentList');

function renderAgentList() {
  agentListEl.innerHTML = '';
  agents.forEach(a => {
    const div = document.createElement('div');
    div.className = 'agent-item' + (a.linked ? ' agent-linked' : '');
    div.dataset.agentName = a.name;
    div.innerHTML = `
      <div class="status-dot status-${a.linked ? 'active' : a.status}"></div>
      <div class="agent-info">
        <div class="agent-code">${a.code} ‚Äî ${a.name}</div>
        <div class="agent-loc">${a.loc}</div>
      </div>
    `;
    agentListEl.appendChild(div);
  });
}
renderAgentList();

function focusAgent(name) {
  if (!name) return;
  const upper = name.toUpperCase();
  const items = agentListEl.querySelectorAll('.agent-item');
  items.forEach(item => item.classList.remove('agent-focus'));
  // Match by name or code
  const target = agentListEl.querySelector(`[data-agent-name="${upper}"]`)
    || [...items].find(el => {
      const a = agents.find(ag => ag.name === el.dataset.agentName);
      return a && a.code === upper;
    });
  if (target) {
    target.classList.add('agent-focus');
    target.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  }
}

function getAgentColor(status) {
  switch (status) {
    case 'active': return { hex: '#00e676', rgb: '0,230,118' };
    case 'standby': return { hex: '#ffab00', rgb: '255,171,0' };
    case 'dark': return { hex: '#ff3d3d', rgb: '255,61,61' };
    case 'linked': return { hex: '#1e90ff', rgb: '30,144,255' };
    default: return { hex: '#444', rgb: '68,68,68' };
  }
}

// ============= MAP CANVAS =============
const mapC = document.getElementById('mapCanvas');
const mapCtx = mapC.getContext('2d');
let mapW, mapH;
// Map projection: maintain 2:1 aspect ratio (world map), centered in canvas
let mapOX = 0, mapOY = 0, mapSW = 0, mapSH = 0;
let mapBgCanvas = null;
let mapBgDirty = true;
const DPR = Math.min(devicePixelRatio || 1, 2);

function resizeMap() {
  const r = mapC.parentElement.getBoundingClientRect();
  mapC.width = r.width * DPR;
  mapC.height = r.height * DPR;
  mapW = mapC.width;
  mapH = mapC.height;
  // Fit 2:1 map into canvas, letterboxed
  const targetRatio = 2;
  const canvasRatio = mapW / mapH;
  if (canvasRatio > targetRatio) {
    // Canvas is wider than 2:1 ‚Üí height-limited
    mapSH = mapH;
    mapSW = mapH * targetRatio;
  } else {
    // Canvas is taller than 2:1 ‚Üí width-limited
    mapSW = mapW;
    mapSH = mapW / targetRatio;
  }
  mapOX = (mapW - mapSW) / 2;
  mapOY = (mapH - mapSH) / 2;
  mapBgDirty = true;
}
resizeMap();
window.addEventListener('resize', resizeMap);

// Convert normalized 0-1 coordinates to canvas pixel coordinates
function mapX(nx) { return mapOX + nx * mapSW; }
function mapY(ny) { return mapOY + ny * mapSH; }

// Simplified world map coordinates (rough outlines)
const continents = [
  // Europe
  [[0.47,0.18],[0.48,0.15],[0.50,0.14],[0.52,0.13],[0.54,0.14],[0.56,0.15],[0.57,0.18],[0.56,0.22],[0.54,0.25],[0.52,0.26],[0.50,0.28],[0.48,0.27],[0.46,0.24],[0.45,0.20]],
  // Africa
  [[0.45,0.32],[0.48,0.30],[0.52,0.30],[0.55,0.33],[0.56,0.38],[0.55,0.48],[0.54,0.55],[0.52,0.60],[0.50,0.62],[0.48,0.60],[0.46,0.55],[0.44,0.48],[0.43,0.40],[0.44,0.35]],
  // Asia
  [[0.57,0.12],[0.60,0.10],[0.65,0.12],[0.70,0.14],[0.75,0.18],[0.78,0.22],[0.80,0.28],[0.78,0.32],[0.75,0.35],[0.70,0.34],[0.65,0.30],[0.60,0.28],[0.58,0.25],[0.57,0.20]],
  // North America
  [[0.12,0.12],[0.18,0.10],[0.24,0.12],[0.28,0.18],[0.30,0.25],[0.28,0.30],[0.24,0.32],[0.20,0.30],[0.16,0.28],[0.12,0.24],[0.10,0.18]],
  // South America
  [[0.24,0.38],[0.28,0.36],[0.30,0.40],[0.32,0.48],[0.30,0.58],[0.28,0.65],[0.26,0.68],[0.24,0.65],[0.22,0.58],[0.21,0.48],[0.22,0.42]],
  // Australia
  [[0.78,0.52],[0.82,0.50],[0.86,0.52],[0.87,0.56],[0.85,0.60],[0.82,0.62],[0.79,0.60],[0.77,0.56]],
];

let trackingPoints = [];
function rebuildTrackingPoints() {
  trackingPoints = agents.filter(a => a.x != null && a.name !== 'PAPA').map(a => ({
    x: a.x, y: a.y, label: a.name, locLabel: a.loc.split(',')[0],
    active: a.status !== 'offline' && a.status !== 'dark',
    hq: !!a.hq, status: a.status, agentName: a.name, linked: !!a.linked,
  }));
}
rebuildTrackingPoints();

let sweepAngle = 0;
let mapTime = 0;

// ---- EVENTS SYSTEM ----
const mapEvents = [];

const eventTypes = [
  { type: 'alert', color: [255,61,61], label: '‚ö† THREAT DETECTED', duration: 280, icon: 'alert' },
  { type: 'intercept', color: [255,171,0], label: 'SIGNAL INTERCEPT', duration: 220, icon: 'intercept' },
  { type: 'breach', color: [255,61,61], label: 'SECURITY BREACH', duration: 300, icon: 'breach' },
  { type: 'contact', color: [0,230,118], label: 'ASSET CONTACT', duration: 200, icon: 'contact' },
  { type: 'movement', color: [30,144,255], label: 'TARGET MOVEMENT', duration: 250, icon: 'move' },
  { type: 'detonation', color: [255,100,30], label: 'üí• EXPLOSION REPORTED', duration: 350, icon: 'explosion' },
  { type: 'cyber', color: [180,80,255], label: 'CYBER INTRUSION', duration: 240, icon: 'cyber' },
  { type: 'extraction', color: [0,230,118], label: 'EXTRACTION IN PROGRESS', duration: 260, icon: 'extraction' },
];

const eventLocations = [
  { x: 0.53, y: 0.22, name: 'VIENNA' },
  { x: 0.49, y: 0.20, name: 'PRAGUE' },
  { x: 0.55, y: 0.26, name: 'ATHENS' },
  { x: 0.46, y: 0.35, name: 'CASABLANCA' },
  { x: 0.65, y: 0.22, name: 'TEHRAN' },
  { x: 0.72, y: 0.26, name: 'MUMBAI' },
  { x: 0.82, y: 0.30, name: 'HONG KONG' },
  { x: 0.85, y: 0.20, name: 'TOKYO' },
  { x: 0.22, y: 0.22, name: 'NEW YORK' },
  { x: 0.16, y: 0.28, name: 'MEXICO CITY' },
  { x: 0.51, y: 0.18, name: 'HAMBURG' },
  { x: 0.59, y: 0.18, name: 'ST PETERSBURG' },
  { x: 0.44, y: 0.24, name: 'PARIS' },
  { x: 0.42, y: 0.22, name: 'MADRID' },
  { x: 0.54, y: 0.20, name: 'WARSAW' },
  { x: 0.28, y: 0.42, name: 'BOGOTA' },
  { x: 0.68, y: 0.18, name: 'ALMATY' },
  { x: 0.75, y: 0.32, name: 'BANGKOK' },
  { x: 0.56, y: 0.30, name: 'CAIRO' },
  { x: 0.50, y: 0.26, name: 'ROME' },
];

function spawnEvent() {
  const evType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
  const loc = eventLocations[Math.floor(Math.random() * eventLocations.length)];
  mapEvents.push({
    ...evType,
    x: loc.x + (Math.random() - 0.5) * 0.02,
    y: loc.y + (Math.random() - 0.5) * 0.02,
    name: loc.name,
    age: 0,
    maxAge: evType.duration,
    ringPhase: 0,
  });
  if (mapEvents.length > 8) mapEvents.shift();
}

// Spawn events at varying intervals
setInterval(spawnEvent, 2800);
setInterval(spawnEvent, 7500);
// Initial events
for (let i = 0; i < 3; i++) { setTimeout(spawnEvent, i * 800); }

// ---- DATA PACKETS traveling along lines ----
const dataPackets = [];
function spawnPacket() {
  const hq = trackingPoints.find(p => p.hq);
  const targets = trackingPoints.filter(p => p.active && !p.hq);
  if (!hq || targets.length === 0) return;
  const target = targets[Math.floor(Math.random() * targets.length)];
  const outbound = Math.random() > 0.4;
  dataPackets.push({
    fromX: outbound ? hq.x : target.x,
    fromY: outbound ? hq.y : target.y,
    toX: outbound ? target.x : hq.x,
    toY: outbound ? target.y : hq.y,
    progress: 0,
    speed: 0.005 + Math.random() * 0.008,
    color: outbound ? [30,144,255] : [0,230,118],
  });
  if (dataPackets.length > 10) dataPackets.shift();
}
setInterval(spawnPacket, 1200);

// ---- MOVING AGENT (PAPA) ----
let agentPapa = { x: 0.53, y: 0.23, targetX: 0.53, targetY: 0.23, trail: [] };
function moveAgentPapa() {
  // Pick random nearby destination
  agentPapa.targetX = agentPapa.x + (Math.random() - 0.5) * 0.06;
  agentPapa.targetY = agentPapa.y + (Math.random() - 0.5) * 0.04;
  agentPapa.targetX = Math.max(0.40, Math.min(0.65, agentPapa.targetX));
  agentPapa.targetY = Math.max(0.15, Math.min(0.35, agentPapa.targetY));
}
setInterval(moveAgentPapa, 4000);
moveAgentPapa();

// ---- THREAT ZONES ----
const threatZones = [
  { x: 0.54, y: 0.23, r: 0.04, label: 'ZONE ALPHA' },
  { x: 0.65, y: 0.22, r: 0.035, label: 'ZONE BRAVO' },
];

// ---- Offscreen cache for static map background ----
function renderMapBg() {
  if (!mapBgCanvas) mapBgCanvas = document.createElement('canvas');
  mapBgCanvas.width = mapW;
  mapBgCanvas.height = mapH;
  const ctx = mapBgCanvas.getContext('2d');
  // Grid
  ctx.strokeStyle = 'rgba(30,144,255,0.06)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for (let i = 0; i < 20; i++) {
    ctx.moveTo(mapW * i / 20, 0); ctx.lineTo(mapW * i / 20, mapH);
    ctx.moveTo(0, mapH * i / 20); ctx.lineTo(mapW, mapH * i / 20);
  }
  ctx.stroke();
  // Continents
  ctx.strokeStyle = 'rgba(30,144,255,0.25)';
  ctx.fillStyle = 'rgba(30,144,255,0.04)';
  ctx.lineWidth = 1.5;
  continents.forEach(pts => {
    ctx.beginPath();
    pts.forEach((p, i) => {
      const x = mapOX + p[0] * mapSW, y = mapOY + p[1] * mapSH;
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
  });
  mapBgDirty = false;
}

function drawMap() {
  mapCtx.clearRect(0, 0, mapW, mapH);
  // Cached static background
  if (mapBgDirty || !mapBgCanvas) renderMapBg();
  mapCtx.drawImage(mapBgCanvas, 0, 0);

  // ---- THREAT ZONES (pulsing dashed circles) ----
  threatZones.forEach(tz => {
    const cx = mapX(tz.x), cy = mapY(tz.y);
    const r = tz.r * mapSW;
    const pulse = 1 + Math.sin(mapTime * 0.04) * 0.15;
    const alpha = 0.12 + Math.sin(mapTime * 0.05) * 0.08;
    mapCtx.fillStyle = `rgba(255,61,61,${alpha * 0.3})`;
    mapCtx.beginPath();
    mapCtx.arc(cx, cy, r * pulse, 0, Math.PI * 2);
    mapCtx.fill();
    mapCtx.strokeStyle = `rgba(255,61,61,${alpha + 0.1})`;
    mapCtx.lineWidth = 1;
    mapCtx.stroke();
  });

  // --- Satellite orbits ---
  satellites.forEach(sat => {
    const t = (mapTime / sat.period + sat.phase / (Math.PI * 2)) % 1;
    const [r, g, b] = sat.color;

    // Draw orbit path (dashed sine wave)
    mapCtx.strokeStyle = `rgba(${r},${g},${b},0.12)`;
    mapCtx.lineWidth = 1;
    mapCtx.setLineDash([4, 6]);
    mapCtx.beginPath();
    for (let i = 0; i <= 80; i++) {
      const fx = i / 80;
      const fy = 0.5 + Math.sin(fx * Math.PI * 2 + sat.phase) * sat.incl;
      const px = mapX(fx), py = mapY(fy);
      i === 0 ? mapCtx.moveTo(px, py) : mapCtx.lineTo(px, py);
    }
    mapCtx.stroke();
    mapCtx.setLineDash([]);

    // Satellite current position (discrete steps synced to blink)
    const stepInterval = 120;
    const step = Math.floor((mapTime + sat.phase * 100) / stepInterval);
    const sx = (step * stepInterval / sat.period + sat.phase / (Math.PI * 2)) % 1;
    const sy = 0.5 + Math.sin(sx * Math.PI * 2 + sat.phase) * sat.incl;
    const px = mapX(sx), py = mapY(sy);

    const blink = 0.85;
    mapCtx.fillStyle = `rgba(${r},${g},${b},${blink})`;
    mapCtx.beginPath();
    mapCtx.moveTo(px, py - 4);
    mapCtx.lineTo(px + 3, py);
    mapCtx.lineTo(px, py + 4);
    mapCtx.lineTo(px - 3, py);
    mapCtx.closePath();
    mapCtx.fill();

    // Label
    mapCtx.font = '9px monospace';
    mapCtx.fillStyle = `rgba(${r},${g},${b},0.5)`;
    mapCtx.fillText(sat.id, px + 8, py + 3);
  });

  // Connection lines between active points (batched single path)
  const hq = trackingPoints.find(p => p.hq);
  if (hq) {
    const hqx = mapX(hq.x), hqy = mapY(hq.y);
    mapCtx.strokeStyle = 'rgba(30,144,255,0.08)';
    mapCtx.lineWidth = 1;
    mapCtx.setLineDash([4, 8]);
    mapCtx.beginPath();
    trackingPoints.forEach(p => {
      if (p.active && !p.hq) {
        mapCtx.moveTo(hqx, hqy);
        mapCtx.lineTo(mapX(p.x), mapY(p.y));
      }
    });
    mapCtx.stroke();
    mapCtx.setLineDash([]);
  }

  // ---- DATA PACKETS ----
  for (let i = dataPackets.length - 1; i >= 0; i--) {
    const dp = dataPackets[i];
    dp.progress += dp.speed;
    if (dp.progress >= 1) { dataPackets.splice(i, 1); continue; }
    const nx = dp.fromX + (dp.toX - dp.fromX) * dp.progress;
    const ny = dp.fromY + (dp.toY - dp.fromY) * dp.progress;
    const px = mapX(nx), py = mapY(ny);
    const arcY = -Math.sin(dp.progress * Math.PI) * 20;
    const finalPy = py + arcY;
    const [r,g,b] = dp.color;
    mapCtx.fillStyle = `rgba(${r},${g},${b},0.15)`;
    mapCtx.beginPath();
    mapCtx.arc(px, finalPy, 7, 0, Math.PI * 2);
    mapCtx.fill();
    mapCtx.fillStyle = `rgba(${r},${g},${b},0.9)`;
    mapCtx.beginPath();
    mapCtx.arc(px, finalPy, 3, 0, Math.PI * 2);
    mapCtx.fill();
    mapCtx.fillStyle = `rgba(${r},${g},${b},0.2)`;
    for (let t = 1; t <= 2; t++) {
      const tp = dp.progress - dp.speed * t * 3;
      if (tp < 0) break;
      const tnx = dp.fromX + (dp.toX - dp.fromX) * tp;
      const tny = dp.fromY + (dp.toY - dp.fromY) * tp;
      const tx = mapX(tnx), ty = mapY(tny) - Math.sin(tp * Math.PI) * 20;
      mapCtx.beginPath();
      mapCtx.arc(tx, ty, 2 - t * 0.3, 0, Math.PI * 2);
      mapCtx.fill();
    }
  }

  // Tracking points (agents) ‚Äî precompute positions, then batch by draw type
  const tpData = trackingPoints.map(p => {
    const ac = getAgentColor(p.status);
    return {
      x: mapX(p.x), y: mapY(p.y),
      rc: p.hq ? '0,230,118' : ac.rgb,
      dot: p.hq ? '#00e676' : ac.hex,
      ringSpeed: p.hq ? 0.6 : 0.8,
      active: p.active, hq: p.hq,
      label: p.label, locLabel: p.locLabel,
    };
  });

  // Pulse rings (batched per similar alpha ‚Äî 2 passes)
  mapCtx.lineWidth = 1.5;
  tpData.forEach(t => {
    const pr = 6 + (mapTime * t.ringSpeed % 50) * 0.7;
    const pa = Math.max(0, 0.35 - (mapTime * t.ringSpeed % 50) * 0.007);
    if (pa > 0.01) {
      mapCtx.strokeStyle = `rgba(${t.rc},${pa})`;
      mapCtx.beginPath(); mapCtx.arc(t.x, t.y, pr, 0, Math.PI * 2); mapCtx.stroke();
    }
    const pr2 = 6 + ((mapTime * t.ringSpeed + 25) % 50) * 0.7;
    const pa2 = Math.max(0, 0.25 - ((mapTime * t.ringSpeed + 25) % 50) * 0.005);
    if (pa2 > 0.01) {
      mapCtx.strokeStyle = `rgba(${t.rc},${pa2})`;
      mapCtx.beginPath(); mapCtx.arc(t.x, t.y, pr2, 0, Math.PI * 2); mapCtx.stroke();
    }
  });

  // Glow circles + dots (batched)
  tpData.forEach(t => {
    mapCtx.fillStyle = `rgba(${t.rc},0.2)`;
    mapCtx.beginPath(); mapCtx.arc(t.x, t.y, 10, 0, Math.PI * 2); mapCtx.fill();
    mapCtx.fillStyle = t.dot;
    mapCtx.beginPath(); mapCtx.arc(t.x, t.y, 4, 0, Math.PI * 2); mapCtx.fill();
  });

  // Crosshairs (single batch)
  mapCtx.strokeStyle = 'rgba(30,144,255,0.25)';
  mapCtx.lineWidth = 1;
  mapCtx.beginPath();
  tpData.forEach(t => {
    if (t.active && !t.hq) {
      mapCtx.moveTo(t.x - 10, t.y); mapCtx.lineTo(t.x - 6, t.y);
      mapCtx.moveTo(t.x + 6, t.y); mapCtx.lineTo(t.x + 10, t.y);
      mapCtx.moveTo(t.x, t.y - 10); mapCtx.lineTo(t.x, t.y - 6);
      mapCtx.moveTo(t.x, t.y + 6); mapCtx.lineTo(t.x, t.y + 10);
    }
  });
  mapCtx.stroke();

  // Labels (single font set, batch text)
  mapCtx.font = 'bold 13px "Orbitron"';
  tpData.forEach(t => {
    mapCtx.fillStyle = `rgba(${t.rc},0.8)`;
    mapCtx.fillText(t.label, t.x + 12, t.y - 2);
  });
  mapCtx.font = '10px "Share Tech Mono"';
  mapCtx.fillStyle = 'rgba(200,216,236,0.3)';
  tpData.forEach(t => { mapCtx.fillText(t.locLabel, t.x + 12, t.y + 12); });

  // ---- AGENT PAPA MOVING DOT ----
  agentPapa.x += (agentPapa.targetX - agentPapa.x) * 0.01;
  agentPapa.y += (agentPapa.targetY - agentPapa.y) * 0.01;
  agentPapa.trail.push({ x: agentPapa.x, y: agentPapa.y });
  if (agentPapa.trail.length > 60) agentPapa.trail.shift();
  mapCtx.strokeStyle = 'rgba(255,171,0,0.15)';
  mapCtx.lineWidth = 1.5;
  mapCtx.beginPath();
  agentPapa.trail.forEach((pt, i) => {
    const sx = mapX(pt.x), sy = mapY(pt.y);
    i === 0 ? mapCtx.moveTo(sx, sy) : mapCtx.lineTo(sx, sy);
  });
  mapCtx.stroke();
  const ax = mapX(agentPapa.x), ay = mapY(agentPapa.y);
  mapCtx.fillStyle = 'rgba(255,171,0,0.2)';
  mapCtx.beginPath();
  mapCtx.arc(ax, ay, 12, 0, Math.PI * 2);
  mapCtx.fill();
  mapCtx.fillStyle = '#ffab00';
  mapCtx.beginPath();
  mapCtx.arc(ax, ay, 5, 0, Math.PI * 2);
  mapCtx.fill();
  mapCtx.font = 'bold 14px "Orbitron"';
  mapCtx.fillStyle = '#ffab00';
  mapCtx.fillText('PAPA', ax + 10, ay - 8);
  mapCtx.strokeStyle = 'rgba(255,171,0,0.4)';
  mapCtx.lineWidth = 1;
  const dSize = 10 + Math.sin(mapTime * 0.08) * 3;
  mapCtx.save();
  mapCtx.translate(ax, ay);
  mapCtx.rotate(Math.PI / 4);
  mapCtx.strokeRect(-dSize, -dSize, dSize * 2, dSize * 2);
  mapCtx.restore();

  // ---- MAP EVENTS ----
  for (let i = mapEvents.length - 1; i >= 0; i--) {
    const ev = mapEvents[i];
    ev.age++;
    if (ev.age > ev.maxAge) { mapEvents.splice(i, 1); continue; }

    const ex = mapX(ev.x), ey = mapY(ev.y);
    const lifeRatio = ev.age / ev.maxAge;
    const [r,g,b] = ev.color;
    const fadeAlpha = lifeRatio < 0.1 ? lifeRatio * 10 : (lifeRatio > 0.8 ? (1 - lifeRatio) * 5 : 1);

    const ringR = ev.age * 0.6;
    const ringAlpha = Math.max(0, (0.5 - ringR * 0.005)) * fadeAlpha;
    if (ringAlpha > 0.01) {
      mapCtx.strokeStyle = `rgba(${r},${g},${b},${ringAlpha})`;
      mapCtx.lineWidth = 1.5;
      mapCtx.beginPath();
      mapCtx.arc(ex, ey, ringR, 0, Math.PI * 2);
      mapCtx.stroke();
    }

    const blinkOn = Math.sin(ev.age * 0.2) > -0.3;
    if (blinkOn) {
      mapCtx.fillStyle = `rgba(${r},${g},${b},${0.15 * fadeAlpha})`;
      mapCtx.beginPath();
      mapCtx.arc(ex, ey, 10, 0, Math.PI * 2);
      mapCtx.fill();
      mapCtx.fillStyle = `rgba(${r},${g},${b},${0.8 * fadeAlpha})`;
      mapCtx.beginPath();
      mapCtx.arc(ex, ey, 4, 0, Math.PI * 2);
      mapCtx.fill();
    }

    const rr = 18 + Math.sin(ev.age * 0.05) * 4;
    mapCtx.strokeStyle = `rgba(${r},${g},${b},${0.3 * fadeAlpha})`;
    mapCtx.lineWidth = 1;
    mapCtx.strokeRect(ex - rr, ey - rr, rr * 2, rr * 2);

    if (lifeRatio < 0.85) {
      const labelAlpha = fadeAlpha * 0.9;
      mapCtx.font = '12px "Orbitron"';
      mapCtx.fillStyle = `rgba(${r},${g},${b},${0.12 * labelAlpha})`;
      mapCtx.fillRect(ex + 22, ey - 18, 180, 22);
      mapCtx.fillStyle = `rgba(${r},${g},${b},${0.85 * labelAlpha})`;
      mapCtx.fillText(ev.label, ex + 30, ey - 2);
      mapCtx.font = '10px "Share Tech Mono"';
      mapCtx.fillStyle = `rgba(${r},${g},${b},${0.5 * labelAlpha})`;
      mapCtx.fillText(ev.name, ex + 30, ey + 16);
    }

    if (ev.icon === 'explosion' && ev.age < 60) {
      for (let p = 0; p < 8; p++) {
        const angle = (p / 8) * Math.PI * 2 + ev.age * 0.1;
        const dist = ev.age * 1.2;
        const px = ex + Math.cos(angle) * dist;
        const py = ey + Math.sin(angle) * dist;
        const pAlpha = Math.max(0, 0.6 - ev.age * 0.01);
        mapCtx.fillStyle = `rgba(255,${100 + ev.age},30,${pAlpha})`;
        mapCtx.beginPath();
        mapCtx.arc(px, py, 2, 0, Math.PI * 2);
        mapCtx.fill();
      }
    }
  }

  // Sweep line from Langley (single arc fill, no per-frame gradient)
  if (hq) {
    const cx = mapX(hq.x), cy = mapY(hq.y);
    const sweepLen = mapSW * 0.25;
    mapCtx.save();
    mapCtx.beginPath();
    mapCtx.moveTo(cx, cy);
    mapCtx.arc(cx, cy, sweepLen, sweepAngle - 0.15, sweepAngle + 0.15);
    mapCtx.closePath();
    mapCtx.fillStyle = 'rgba(0,230,118,0.06)';
    mapCtx.fill();
    mapCtx.restore();
    sweepAngle += 0.015;
  }

  // ---- COORDINATE READOUT (bottom left of map) ----
  mapCtx.font = '14px "Share Tech Mono"';
  mapCtx.fillStyle = 'rgba(200,216,236,0.2)';
  const lat = (48.2 + Math.sin(mapTime * 0.01) * 0.3).toFixed(4);
  const lon = (16.4 + Math.cos(mapTime * 0.01) * 0.5).toFixed(4);
  mapCtx.fillText(`LAT ${lat}¬∞N  LON ${lon}¬∞E  ALT 342m  BEARING ${(mapTime * 0.5 % 360).toFixed(0)}¬∞`, 20, mapH - 20);

  mapTime++;
}

// ============= MAP DRAG & DROP =============
let mapDrag = null; // { agent, isPapa }
let _mapRect = null;
function cacheMapRect() { _mapRect = mapC.getBoundingClientRect(); }
cacheMapRect();
window.addEventListener('resize', cacheMapRect);
window.addEventListener('scroll', cacheMapRect);

function canvasToNorm(clientX, clientY) {
  if (!_mapRect) cacheMapRect();
  const cx = (clientX - _mapRect.left) * (mapC.width / _mapRect.width);
  const cy = (clientY - _mapRect.top) * (mapC.height / _mapRect.height);
  return { nx: (cx - mapOX) / mapSW, ny: (cy - mapOY) / mapSH };
}

function hitTestAgent(clientX, clientY) {
  const { nx, ny } = canvasToNorm(clientX, clientY);
  const hitR = 20 / mapSW; // ~20 canvas px radius
  // Check PAPA first (top layer)
  const pdx = agentPapa.x - nx, pdy = agentPapa.y - ny;
  if (Math.sqrt(pdx*pdx + pdy*pdy) < hitR) {
    return { agent: agents.find(a => a.name === 'PAPA'), isPapa: true };
  }
  // Check other agents
  for (const a of agents) {
    if (a.x == null || a.name === 'PAPA') continue;
    const dx = a.x - nx, dy = a.y - ny;
    if (Math.sqrt(dx*dx + dy*dy) < hitR) return { agent: a, isPapa: false };
  }
  return null;
}

mapC.addEventListener('mousedown', (e) => {
  const hit = hitTestAgent(e.clientX, e.clientY);
  if (!hit) return;
  e.preventDefault();
  e.stopPropagation();
  mapDrag = hit;
  mapC.style.cursor = 'grabbing';
  focusAgent(hit.agent.name);
});

window.addEventListener('mousemove', (e) => {
  if (!mapDrag) {
    // Hover cursor ‚Äî only check when inside map
    if (!_mapRect) return;
    const inside = e.clientX >= _mapRect.left && e.clientX <= _mapRect.right && e.clientY >= _mapRect.top && e.clientY <= _mapRect.bottom;
    if (!inside) return;
    const hit = hitTestAgent(e.clientX, e.clientY);
    mapC.style.cursor = hit ? 'grab' : '';
    return;
  }
  e.preventDefault();
  const { nx, ny } = canvasToNorm(e.clientX, e.clientY);
  const clampX = Math.max(0.05, Math.min(0.95, nx));
  const clampY = Math.max(0.05, Math.min(0.95, ny));
  if (mapDrag.isPapa) {
    agentPapa.x = clampX;
    agentPapa.y = clampY;
    agentPapa.targetX = clampX;
    agentPapa.targetY = clampY;
    agentPapa.trail = [];
  } else {
    mapDrag.agent.x = clampX;
    mapDrag.agent.y = clampY;
    rebuildTrackingPoints();
  }
});

window.addEventListener('mouseup', () => {
  if (!mapDrag) return;
  mapC.style.cursor = 'grab';
  mapDrag = null;
});

// ============= RADAR DISPLAY =============
const radarC = document.getElementById('radarCanvas');
const radarCtx = radarC.getContext('2d');
let radarAngle = 0;

// Radar blips (random contacts)
const radarBlips = [];
for (let i = 0; i < 8; i++) {
  const a = Math.random() * Math.PI * 2;
  const d = 0.2 + Math.random() * 0.7;
  radarBlips.push({
    angle: a, dist: d,
    speed: (Math.random() - 0.5) * 0.003,
    drift: (Math.random() - 0.5) * 0.002,
    hostile: Math.random() > 0.6,
    age: 0,
  });
}

let radarBgCanvas = null;
let radarBgDirty = true;
function resizeRadar() {
  const r = radarC.parentElement.getBoundingClientRect();
  radarC.width = r.width * DPR;
  radarC.height = r.height * DPR;
  radarBgDirty = true;
}
resizeRadar();
window.addEventListener('resize', resizeRadar);

function renderRadarBg(w, h, cx, cy, radius) {
  if (!radarBgCanvas) radarBgCanvas = document.createElement('canvas');
  radarBgCanvas.width = w; radarBgCanvas.height = h;
  const ctx = radarBgCanvas.getContext('2d');
  // Range rings
  for (let i = 1; i <= 4; i++) {
    const r = radius * i / 4;
    ctx.strokeStyle = `rgba(30,144,255,${0.08 + i * 0.02})`;
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.stroke();
  }
  // Cross + diagonal lines
  ctx.strokeStyle = 'rgba(30,144,255,0.1)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(cx - radius, cy); ctx.lineTo(cx + radius, cy);
  ctx.moveTo(cx, cy - radius); ctx.lineTo(cx, cy + radius);
  ctx.stroke();
  ctx.strokeStyle = 'rgba(30,144,255,0.05)';
  ctx.beginPath();
  const d45 = radius * 0.707;
  ctx.moveTo(cx - d45, cy - d45); ctx.lineTo(cx + d45, cy + d45);
  ctx.moveTo(cx + d45, cy - d45); ctx.lineTo(cx - d45, cy + d45);
  ctx.stroke();
  // Range labels
  ctx.font = '10px "Share Tech Mono"';
  ctx.fillStyle = 'rgba(30,144,255,0.3)';
  for (let i = 1; i <= 4; i++) ctx.fillText(`${i * 25}km`, cx + 4, cy - radius * i / 4 + 12);
  // Bearing labels
  ctx.fillStyle = 'rgba(200,216,236,0.25)';
  ctx.font = '11px "Orbitron"';
  ctx.textAlign = 'center';
  ctx.fillText('N', cx, cy - radius - 6);
  ctx.fillText('S', cx, cy + radius + 14);
  ctx.textAlign = 'left';
  ctx.fillText('E', cx + radius + 6, cy + 4);
  ctx.textAlign = 'right';
  ctx.fillText('W', cx - radius - 6, cy + 4);
  ctx.textAlign = 'left';
  radarBgDirty = false;
}

function drawRadar() {
  const w = radarC.width, h = radarC.height;
  const cx = w / 2, cy = h / 2;
  const radius = Math.min(cx, cy) * 0.88;

  radarCtx.clearRect(0, 0, w, h);

  // Cached static background
  if (radarBgDirty || !radarBgCanvas) renderRadarBg(w, h, cx, cy, radius);
  radarCtx.drawImage(radarBgCanvas, 0, 0);

  // Sweep cone (simple arc fill instead of conicGradient)
  radarCtx.fillStyle = 'rgba(0,230,118,0.08)';
  radarCtx.beginPath();
  radarCtx.moveTo(cx, cy);
  radarCtx.arc(cx, cy, radius, radarAngle - 0.8, radarAngle);
  radarCtx.closePath();
  radarCtx.fill();

  // Sweep glow arc
  radarCtx.strokeStyle = 'rgba(0,230,118,0.15)';
  radarCtx.lineWidth = 2;
  radarCtx.beginPath();
  radarCtx.arc(cx, cy, radius, radarAngle - 0.8, radarAngle);
  radarCtx.stroke();

  // Blips
  radarBlips.forEach(b => {
    b.angle += b.speed;
    b.dist = Math.max(0.1, Math.min(0.95, b.dist + b.drift));
    // Occasionally change drift
    if (Math.random() < 0.005) b.drift = (Math.random() - 0.5) * 0.002;

    const bx = cx + Math.cos(b.angle) * b.dist * radius;
    const by = cy + Math.sin(b.angle) * b.dist * radius;

    // Brightness based on sweep proximity
    let angleDiff = radarAngle - b.angle;
    while (angleDiff < 0) angleDiff += Math.PI * 2;
    while (angleDiff > Math.PI * 2) angleDiff -= Math.PI * 2;
    const brightness = angleDiff < 1.5 ? (1.5 - angleDiff) / 1.5 : 0;
    b.age = brightness > 0.1 ? 1 : Math.max(0, b.age - 0.008);

    const glow = Math.max(brightness, b.age * 0.5);
    if (glow < 0.05) return;

    const color = b.hostile ? [255,61,61] : [0,230,118];
    const [r,g,bb] = color;

    // Blip glow
    radarCtx.fillStyle = `rgba(${r},${g},${bb},${glow * 0.15})`;
    radarCtx.beginPath();
    radarCtx.arc(bx, by, 10, 0, Math.PI * 2);
    radarCtx.fill();

    // Blip dot
    radarCtx.fillStyle = `rgba(${r},${g},${bb},${glow * 0.9})`;
    radarCtx.beginPath();
    radarCtx.arc(bx, by, 3, 0, Math.PI * 2);
    radarCtx.fill();
  });

  // Center dot
  radarCtx.fillStyle = 'rgba(0,230,118,0.2)';
  radarCtx.beginPath();
  radarCtx.arc(cx, cy, 8, 0, Math.PI * 2);
  radarCtx.fill();
  radarCtx.fillStyle = '#00e676';
  radarCtx.beginPath();
  radarCtx.arc(cx, cy, 3, 0, Math.PI * 2);
  radarCtx.fill();

  radarAngle += 0.025;
}

// ============= TARGET FACE (abstract) =============
const tC = document.getElementById('targetCanvas');
const tCtx = tC.getContext('2d');
function resizeTarget() {
  const r = tC.parentElement.getBoundingClientRect();
  tC.width = r.width * DPR;
  tC.height = r.height * DPR;
}
resizeTarget();

function drawTarget() {
  const w = tC.width, h = tC.height;
  tCtx.clearRect(0, 0, w, h);

  tCtx.fillStyle = 'rgba(15,25,45,1)';
  tCtx.fillRect(0, 0, w, h);

  // Use min dimension as base unit to prevent aspect-ratio distortion
  const s = Math.min(w, h);
  const cx = w / 2, cy = h * 0.45;

  // Head shape
  tCtx.fillStyle = 'rgba(30,60,100,0.4)';
  tCtx.beginPath();
  tCtx.ellipse(cx, cy, s * 0.22, s * 0.30, 0, 0, Math.PI * 2);
  tCtx.fill();

  // Shoulders
  tCtx.beginPath();
  tCtx.ellipse(cx, h * 0.85, s * 0.42, s * 0.28, 0, Math.PI, 0);
  tCtx.fill();

  // Facial recognition grid
  tCtx.strokeStyle = 'rgba(30,144,255,0.15)';
  tCtx.lineWidth = 1;
  for (let i = 0; i < 8; i++) {
    const rx = s * 0.06 + i * s * 0.025;
    const ry = s * 0.08 + i * s * 0.033;
    tCtx.beginPath();
    tCtx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
    tCtx.stroke();
  }

  // Scanning line
  const scanY = (Date.now() / 20) % h;
  const grad = tCtx.createLinearGradient(0, scanY - 10, 0, scanY + 10);
  grad.addColorStop(0, 'rgba(255,61,61,0)');
  grad.addColorStop(0.5, 'rgba(255,61,61,0.3)');
  grad.addColorStop(1, 'rgba(255,61,61,0)');
  tCtx.fillStyle = grad;
  tCtx.fillRect(0, scanY - 10, w, 20);

  // Data points ‚Äî relative to head center using s
  const pts = [
    [cx - s*0.10, cy - s*0.08],
    [cx + s*0.10, cy - s*0.08],
    [cx,          cy],
    [cx - s*0.06, cy + s*0.06],
    [cx + s*0.06, cy + s*0.06],
    [cx,          cy + s*0.09],
  ];
  tCtx.fillStyle = 'rgba(255,61,61,0.6)';
  pts.forEach(p => {
    tCtx.beginPath();
    tCtx.arc(p[0], p[1], 3, 0, Math.PI * 2);
    tCtx.fill();
  });
  tCtx.strokeStyle = 'rgba(255,61,61,0.2)';
  tCtx.lineWidth = 1;
  tCtx.beginPath();
  pts.forEach((p, i) => { i === 0 ? tCtx.moveTo(p[0], p[1]) : tCtx.lineTo(p[0], p[1]); });
  tCtx.closePath();
  tCtx.stroke();

  // "MATCH: 94.7%" text
  const matchFS = Math.max(12, Math.min(22, s * 0.08));
  tCtx.font = `bold ${matchFS}px "Orbitron"`;
  tCtx.fillStyle = 'rgba(255,61,61,0.7)';
  tCtx.fillText('MATCH: 94.7%', cx - s * 0.22, h * 0.72);

}


// ============= SIGNAL WAVEFORM =============
const sigC = document.getElementById('signalCanvas');
const sigCtx = sigC.getContext('2d');
function resizeSig() {
  const r = sigC.parentElement.getBoundingClientRect();
  sigC.width = r.width * DPR;
  sigC.height = r.height * DPR;
}
resizeSig();

let sigOffset = 0;
function drawSignal() {
  const w = sigC.width, h = sigC.height;
  sigCtx.clearRect(0, 0, w, h);
  
  // Waveform
  sigCtx.strokeStyle = 'rgba(0,230,118,0.5)';
  sigCtx.lineWidth = 1.5;
  sigCtx.beginPath();
  for (let x = 0; x < w; x += 2) {
    const t = x / w * 12 + sigOffset;
    const y = h/2 + Math.sin(t) * h*0.25 + Math.sin(t*2.7) * h*0.12 + Math.sin(t*0.5) * h*0.1 + (Math.random()-0.5) * 4;
    x === 0 ? sigCtx.moveTo(x, y) : sigCtx.lineTo(x, y);
  }
  sigCtx.stroke();

  // Second waveform (encrypted signal)
  sigCtx.strokeStyle = 'rgba(30,144,255,0.3)';
  sigCtx.lineWidth = 1;
  sigCtx.beginPath();
  for (let x = 0; x < w; x += 2) {
    const t = x / w * 18 + sigOffset * 1.3;
    const y = h/2 + Math.sin(t*1.5) * h*0.15 + Math.cos(t*3) * h*0.08 + (Math.random()-0.5) * 6;
    x === 0 ? sigCtx.moveTo(x, y) : sigCtx.lineTo(x, y);
  }
  sigCtx.stroke();

  // Center line
  sigCtx.strokeStyle = 'rgba(200,216,236,0.07)';
  sigCtx.lineWidth = 1;
  sigCtx.beginPath();
  sigCtx.moveTo(0, h/2);
  sigCtx.lineTo(w, h/2);
  sigCtx.stroke();

  sigOffset += 0.08;
}

// ============= UNIFIED RENDER LOOP =============
let _frame = 0;
function animate() {
  _frame++;
  if (_frame & 1) { // 30fps for map & radar
    drawMap();
    drawRadar();
  }
  if (_frame % 3 === 0) { // ~20fps for target & signal
    drawTarget();
    drawSignal();
  }
  requestAnimationFrame(animate);
}
animate();

// ============= DATA FEED =============
const feedEl = document.getElementById('dataFeed');
const feedLines = [
  '<span class="info">[NSA-RELAY]</span> Intercept decoded: PROMETHEUS cell Ankara ‚Äî Freq 14.223 MHz',
  '<span class="highlight">[SIGINT]</span> Pattern match: Financial transfer ‚Çø47.3 ‚Üí Wallet 0xAE3...F91 ‚Äî Flagged',
  '<span class="warn">[WARNING]</span> Agent 008 ‚Äî last contact 72h ago ‚Äî Protocol NIGHTSHADE initiated',
  '<span class="info">[SAT-3]</span> Geosync lock confirmed: 48.2083¬∞N, 16.3731¬∞E ‚Äî Target in range',
  '<span class="alert">[ALERT]</span> Biometric scan mismatch ‚Äî Vienna safehouse door access ‚Äî Possible breach',
  '<span class="highlight">[ECHELON]</span> Keyword trigger: "PROMETHEUS" + "shipment" ‚Äî 3 intercepts flagged',
  '<span class="info">[CIA-SAD]</span> PAPA en route to extraction point ‚Äî ETA 14 minutes',
  '<span class="warn">[CYBER]</span> DDoS attempt on ARGUS NODE-3 ‚Äî Blocked ‚Äî Origin: 185.220.xx.xx (TOR exit)',
  '<span class="highlight">[HUMINT]</span> Asset BLUEBIRD confirms: Arms cache relocated ‚Äî New coords pending',
  '<span class="alert">[PRIORITY]</span> TECH-DIV: Prototype tracker signal degrading ‚Äî PAPA device battery < 12%',
  '<span class="info">[NSA-LINK]</span> Joint op IRON BRIDGE ‚Äî Phase 2 authorised by COBRA committee',
  '<span class="warn">[COUNTER-INT]</span> Suspected dead drop ‚Äî Regent\'s Park bench 7C ‚Äî Sweep team dispatched',
  '<span class="highlight">[FININT]</span> Shell company KRONOS HOLDINGS ‚Üí linked to 3 PROMETHEUS associates',
  '<span class="info">[SAT-IMINT]</span> Movement detected at compound 48.19N 16.38E ‚Äî 4 vehicles, 12+ personnel',
  '<span class="alert">[FLASH]</span> Agent 004 reports shots fired near Tangier harbour ‚Äî Requesting backup',
  '<span class="highlight">[SIGINT]</span> Encrypted burst transmission decoded ‚Äî Rendezvous: Hotel Sacher, 2200 local',
  '<span class="info">[TECH-DIV]</span> Nanotech tracker firmware updated ‚Äî All field units synced',
  '<span class="warn">[ANOMALY]</span> Passport scan ‚Äî known alias "ERIK VOGT" ‚Äî Zurich airport ‚Äî Gate B14',
];

let feedIdx = 0;
function addFeedLine() {
  pushFeed(feedLines[feedIdx % feedLines.length]);
  feedIdx++;
}

function fmtTs(d) {
  const o = d || new Date();
  const mm = String(o.getMonth()+1).padStart(2,'0');
  const dd = String(o.getDate()).padStart(2,'0');
  return `${mm}-${dd} ${o.toISOString().slice(11,19)}`;
}

function agentLabel(name) {
  const a = agents.find(a => a.name === name);
  return a ? `${a.code} - ${a.name}` : name;
}

// Universal helper: push any HTML line to the SIGINT feed
function pushFeed(html) {
  const line = document.createElement('div');
  line.innerHTML = `<span style="color:var(--text-dim)">${new Date().toISOString().slice(11,19)}Z</span> ${html}`;
  feedEl.appendChild(line);
  while (feedEl.children.length > 20) {
    feedEl.removeChild(feedEl.firstChild);
  }
  feedEl.scrollTop = feedEl.scrollHeight;
}

// Initial fill
for (let i = 0; i < 6; i++) addFeedLine();
setInterval(addFeedLine, 3500);

// Capture JS errors into feed
window.onerror = (msg, src, line) => {
  pushFeed(`<span class="alert">[SYS-ERROR]</span> ${msg} ‚Äî L${line}`);
};
window.addEventListener('unhandledrejection', (e) => {
  pushFeed(`<span class="alert">[SYS-ERROR]</span> ${e.reason}`);
});

// ============= COMMS LOG =============
const commsEl = document.getElementById('commsLog');
const commsLines = [
  { src: 'ORACLE', msg: 'PAPA, new intel on PROMETHEUS ‚Äî uploading now' },
  { src: 'PAPA', msg: 'Copy. Moving to secondary position' },
  { src: 'DIRECTOR', msg: 'All stations: NIGHTFALL protocol is now ACTIVE' },
  { src: 'COBRA', msg: '[ENCRYPTED ‚Äî AES-256 ‚Äî DECRYPTING...]', encrypted: true },
  { src: 'FALCON', msg: 'Tangier harbour compromised. Falling back to Alpha' },
  { src: 'ORACLE', msg: 'Tracker shows target heading NNW ‚Äî speed 85km/h' },
  { src: 'DIRECTOR', msg: 'PAPA: You are authorised. Weapons free.' },
  { src: 'PAPA', msg: 'Understood. Going dark.' },
  { src: 'PHOENIX', msg: 'Istanbul safehouse secure. Awaiting further orders' },
  { src: 'RAVEN', msg: '[ENCRYPTED ‚Äî QUANTUM CIPHER ‚Äî PENDING...]', encrypted: true },
  { src: 'ORACLE', msg: 'Papa, I\'m reading elevated radiation at the compound' },
  { src: 'AEGIS', msg: 'Berlin team in position. Awaiting green light' },
  { src: 'DIRECTOR', msg: 'All units: Hold positions. Do NOT engage until authorised' },
  { src: 'PAPA', msg: 'I have visual on the target. Requesting confirmation' },
  { src: 'SPECTRE', msg: 'Macau contact confirmed. Asset is cooperative.' },
  { src: 'DIRECTOR', msg: 'Confirmed. Execute.' },
];

let commsIdx = 0;
let dummyCommsEnabled = true;
function addCommsLine(tsOverride) {
  if (!dummyCommsEnabled && !tsOverride) return;
  const c = commsLines[commsIdx % commsLines.length];
  const ts = tsOverride || fmtTs();
  const line = document.createElement('div');
  const srcAgent = agents.find(a => a.name === c.src);
  const srcColor = srcAgent ? getAgentColor(srcAgent.status).hex : '';
  const srcStyle = srcColor ? ` style="color:${srcColor}"` : '';
  const label = agentLabel(c.src);
  if (c.encrypted) {
    line.innerHTML = `<span class="ts">${ts}</span> <span class="src"${srcStyle}>${label}</span>: <span class="encrypted">${c.msg}</span>`;
  } else {
    line.innerHTML = `<span class="ts">${ts}</span> <span class="src"${srcStyle}>${label}</span>: <span class="msg">${c.msg}</span>`;
  }
  commsEl.appendChild(line);
  commsIdx++;

  while (commsEl.children.length > 30) {
    commsEl.removeChild(commsEl.firstChild);
  }
  commsEl.scrollTop = commsEl.scrollHeight;
  if (!tsOverride) focusAgent(c.src);
}

// Seed comms with backfilled timestamps so it looks active from the start
{
  const now = Date.now();
  const seedCount = 12;
  for (let i = seedCount; i > 0; i--) {
    const past = new Date(now - i * 4700 - Math.random() * 2000);
    addCommsLine(fmtTs(past));
  }
}
setInterval(addCommsLine, 5000);

// ============= RESIZE HANDLER =============
window.addEventListener('resize', () => {
  resizeMap();
  resizeTarget();
  resizeSig();
});

// ============= MAP ALERT OVERLAY =============
const mapAlertOverlay = document.getElementById('mapAlertOverlay');
const mapAlertTitle = document.getElementById('mapAlertTitle');
const mapAlertDetail = document.getElementById('mapAlertDetail');
const screenFlash = document.getElementById('screenFlash');

const alertMessages = [
  { title: '‚ö† PRIORITY ALERT', detail: 'UNIDENTIFIED CONTACT ‚Äî SECTOR 7-ALPHA' },
  { title: '‚ö† THREAT ESCALATION', detail: 'PROMETHEUS CELL ACTIVATED ‚Äî VIENNA' },
  { title: 'üî¥ AGENT COMPROMISED', detail: 'FALCON-3 COVER BLOWN ‚Äî INITIATING EXTRACTION' },
  { title: '‚ö† WEAPONS DETECTED', detail: 'RADIOLOGICAL SIGNATURE ‚Äî TEHRAN COMPOUND' },
  { title: 'üî¥ SECURITY BREACH', detail: 'CIA NETWORK INTRUSION ATTEMPT ‚Äî BLOCKED' },
  { title: '‚ö† INTERCEPT DECODED', detail: 'PROMETHEUS: "THE PACKAGE MOVES AT DAWN"' },
  { title: '‚ö† HOSTILE MOVEMENT', detail: 'ARMED CONVOY ‚Äî 12 VEHICLES ‚Äî HEADING NNW' },
  { title: 'üî¥ DETONATION EVENT', detail: 'EXPLOSION CONFIRMED ‚Äî ISTANBUL SAFEHOUSE' },
  { title: '‚ö† SATELLITE ANOMALY', detail: 'UNKNOWN OBJECT ENTERING LOW ORBIT' },
  { title: 'üî¥ ASSET IN DANGER', detail: 'BLUEBIRD SENDS DISTRESS ‚Äî CASABLANCA' },
  { title: '‚ö† CIPHER BROKEN', detail: 'PROMETHEUS ENCRYPTION KEY COMPROMISED' },
  { title: '‚ö† TARGET ACQUIRED', detail: 'PAPA HAS VISUAL ‚Äî AWAITING AUTHORIZATION' },
];

function triggerMapAlert() {
  const msg = alertMessages[Math.floor(Math.random() * alertMessages.length)];
  mapAlertTitle.textContent = msg.title;
  mapAlertDetail.textContent = msg.detail;
  mapAlertOverlay.classList.add('active');
  
  // Screen flash
  screenFlash.classList.remove('active');
  void screenFlash.offsetWidth;
  screenFlash.classList.add('active');

  setTimeout(() => {
    mapAlertOverlay.classList.remove('active');
  }, 3500 + Math.random() * 1500);
}

// Auto events toggle
let autoEventsEnabled = true;
const autoEventKeys = ['1','3','4','5','6','7','8','0']; // exclude 2(explosion), 9(countdown)

function fireAutoEvent() {
  if (!autoEventsEnabled) return;
  const key = autoEventKeys[Math.floor(Math.random() * autoEventKeys.length)];
  keyActions[key].action();
}

// First event after 5s, then random intervals
setTimeout(fireAutoEvent, 5000);
setInterval(fireAutoEvent, 8000 + Math.random() * 12000);
setInterval(() => { if (Math.random() > 0.5) fireAutoEvent(); }, 15000);

// Periodic agent status shuffle (30-60s interval)
const statusPool = ['active', 'standby', 'dark'];
const statusLabel = { active: 'ACTIVE', standby: 'STANDBY', dark: 'DARK' };
setInterval(() => {
  if (!autoEventsEnabled) return;
  const candidates = agents.filter(a => !a.linked && !a.hq && a.name !== 'PAPA');
  if (!candidates.length) return;
  const agent = candidates[Math.floor(Math.random() * candidates.length)];
  const prev = agent.status;
  let next;
  do { next = statusPool[Math.floor(Math.random() * statusPool.length)]; } while (next === prev);
  agent.status = next;
  rebuildTrackingPoints();
  renderAgentList();
  pushFeed(`<span class="info">[FIELD]</span> ${agent.name} status changed: ${statusLabel[prev] || prev.toUpperCase()} ‚Üí ${statusLabel[next]}`);
}, 30000 + Math.random() * 30000);

// ============= WEB AUDIO SYNTH =============
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

let isMuted = false;

function playTone(freq, duration, type='sine', vol=0.15) {
  if (isMuted) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(vol, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

function playNoise(duration, vol=0.08) {
  if (isMuted) return;
  const bufSize = audioCtx.sampleRate * duration;
  const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
  const data = buf.getChannelData(0);
  for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1);
  const src = audioCtx.createBufferSource();
  const gain = audioCtx.createGain();
  const filter = audioCtx.createBiquadFilter();
  filter.type = 'bandpass';
  filter.frequency.value = 2000;
  filter.Q.value = 0.5;
  src.buffer = buf;
  gain.gain.setValueAtTime(vol, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  src.connect(filter);
  filter.connect(gain);
  gain.connect(audioCtx.destination);
  src.start();
}

// Sound presets
const sfx = {
  alert: () => {
    playTone(880, 0.12, 'square', 0.12);
    setTimeout(() => playTone(660, 0.12, 'square', 0.12), 130);
    setTimeout(() => playTone(880, 0.12, 'square', 0.12), 260);
    setTimeout(() => playTone(660, 0.15, 'square', 0.10), 390);
  },
  scan: () => {
    for (let i = 0; i < 6; i++) {
      setTimeout(() => playTone(1200 + i * 200, 0.08, 'sine', 0.06), i * 60);
    }
  },
  explosion: () => {
    playNoise(1.2, 0.2);
    playTone(60, 0.8, 'sine', 0.2);
    setTimeout(() => playTone(40, 0.6, 'sine', 0.15), 100);
    setTimeout(() => playNoise(0.6, 0.1), 200);
  },
  dataStream: () => {
    for (let i = 0; i < 12; i++) {
      setTimeout(() => playTone(2000 + Math.random() * 2000, 0.04, 'sine', 0.04), i * 40);
    }
  },
  lockOn: () => {
    playTone(400, 0.15, 'sine', 0.1);
    setTimeout(() => playTone(600, 0.15, 'sine', 0.1), 150);
    setTimeout(() => playTone(800, 0.3, 'sine', 0.15), 300);
    setTimeout(() => playTone(800, 0.1, 'square', 0.05), 600);
  },
  comms: () => {
    playNoise(0.08, 0.06);
    setTimeout(() => {
      playTone(300, 0.06, 'sine', 0.08);
      playTone(450, 0.06, 'sine', 0.06);
    }, 80);
    setTimeout(() => playNoise(0.05, 0.04), 200);
    for (let i = 0; i < 5; i++) {
      setTimeout(() => playTone(350 + Math.random()*100, 0.05, 'sine', 0.05), 250 + i*60);
    }
  },
  breach: () => {
    for (let i = 0; i < 8; i++) {
      setTimeout(() => {
        playTone(200 + Math.random()*100, 0.1, 'sawtooth', 0.08);
      }, i * 100);
    }
    setTimeout(() => playTone(150, 0.5, 'square', 0.1), 0);
  },
  satellite: () => {
    playTone(1800, 0.6, 'sine', 0.06);
    setTimeout(() => playTone(2200, 0.5, 'sine', 0.06), 200);
    setTimeout(() => playTone(1400, 0.8, 'sine', 0.05), 500);
    for (let i = 0; i < 4; i++) {
      setTimeout(() => playTone(3000 + i*500, 0.03, 'sine', 0.03), 100 + i*150);
    }
  },
  countdown: () => {
    playTone(1000, 0.08, 'square', 0.15);
  },
  confirm: () => {
    playTone(523, 0.1, 'sine', 0.1);
    setTimeout(() => playTone(659, 0.1, 'sine', 0.1), 100);
    setTimeout(() => playTone(784, 0.2, 'sine', 0.12), 200);
  },
};

// ============= KEYBOARD TRIGGERS =============
const keyActions = {
  '1': {
    name: 'RED ALERT',
    action: () => {
      sfx.alert();
      triggerMapAlert();
      document.body.style.boxShadow = 'inset 0 0 80px rgba(255,0,0,0.3)';
      setTimeout(() => document.body.style.boxShadow = 'none', 2000);
      pushFeed('<span class="alert">[RED ALERT]</span> Priority threat detected ‚Äî All stations on high alert');
    }
  },
  '2': {
    name: 'EXPLOSION',
    action: () => {
      sfx.explosion();
      const loc = eventLocations[Math.floor(Math.random() * eventLocations.length)];
      mapEvents.push({
        type: 'detonation', color: [255,100,30], label: 'üí• EXPLOSION CONFIRMED',
        duration: 400, icon: 'explosion',
        x: loc.x, y: loc.y, name: loc.name,
        age: 0, maxAge: 400, ringPhase: 0,
      });
      document.body.style.transform = 'translate(3px, -2px)';
      setTimeout(() => document.body.style.transform = 'translate(-3px, 2px)', 50);
      setTimeout(() => document.body.style.transform = 'translate(2px, 3px)', 100);
      setTimeout(() => document.body.style.transform = 'translate(-1px, -1px)', 150);
      setTimeout(() => document.body.style.transform = 'none', 200);
      screenFlash.classList.remove('active');
      void screenFlash.offsetWidth;
      screenFlash.style.background = 'rgba(255,120,30,0.12)';
      screenFlash.classList.add('active');
      setTimeout(() => screenFlash.style.background = 'rgba(255,30,30,0.06)', 800);
      pushFeed(`<span class="alert">[DETONATION]</span> Explosion confirmed at ${loc.name} ‚Äî Damage assessment pending`);
    }
  },
  '3': {
    name: 'TARGET LOCK',
    action: () => {
      sfx.lockOn();
      moveAgentPapa();
      mapAlertTitle.textContent = 'üéØ TARGET ACQUIRED';
      mapAlertDetail.textContent = 'FACIAL RECOGNITION MATCH ‚Äî 94.7% CONFIDENCE';
      mapAlertOverlay.classList.add('active');
      setTimeout(() => mapAlertOverlay.classList.remove('active'), 3000);
      pushFeed('<span class="warn">[TARGET-LOCK]</span> Facial recognition match 94.7% ‚Äî Target acquired');
    }
  },
  '4': {
    name: 'INCOMING COMMS',
    action: () => {
      sfx.comms();
      // Add urgent comms
      const urgentMsgs = [
        { src: 'PAPA', msg: 'I have the target in sight. Requesting green light.' },
        { src: 'DIRECTOR', msg: 'All stations ‚Äî PRIORITY ONE ‚Äî WEAPONS FREE.' },
        { src: 'ORACLE', msg: 'Papa, get out now. They know you\'re there.' },
        { src: 'AEGIS', msg: 'Extraction team en route. Hold your position.' },
        { src: 'FALCON', msg: 'MAYDAY MAYDAY ‚Äî position compromised. Going dark.' },
      ];
      const msg = urgentMsgs[Math.floor(Math.random() * urgentMsgs.length)];
      const ts = fmtTs();
      const line = document.createElement('div');
      line.innerHTML = `<span class="ts">${ts}</span> <span class="src" style="color:#ff3d3d">‚òÖ ${agentLabel(msg.src)}</span>: <span class="msg" style="color:#e8f0ff">${msg.msg}</span>`;
      commsEl.appendChild(line);
      while (commsEl.children.length > 30) commsEl.removeChild(commsEl.firstChild);
      commsEl.scrollTop = commsEl.scrollHeight;
      pushFeed(`<span class="warn">[COMMS]</span> Priority transmission received from ${msg.src}`);
      focusAgent(msg.src);
    }
  },
  '5': {
    name: 'DATA BURST',
    action: () => {
      sfx.dataStream();
      // Spawn many data packets at once
      for (let i = 0; i < 10; i++) {
        setTimeout(() => spawnPacket(), i * 80);
      }
      const burstLines = [
        '<span class="alert">[FLASH]</span> ENCRYPTED DATA BURST ‚Äî 47.3TB ‚Äî DECRYPTING...',
        '<span class="alert">[PRIORITY]</span> NINE EYES DATABASE ACCESSED ‚Äî UNKNOWN ORIGIN',
        '<span class="highlight">[SIGINT]</span> FULL SPECTRUM INTERCEPT INITIATED ‚Äî ALL CHANNELS',
      ];
      pushFeed(burstLines[Math.floor(Math.random()*burstLines.length)]);
    }
  },
  '6': {
    name: 'SECURITY BREACH',
    action: () => {
      sfx.breach();
      mapAlertTitle.textContent = 'üî¥ SECURITY BREACH';
      mapAlertDetail.textContent = 'PERIMETER COMPROMISED ‚Äî ALL UNITS RESPOND';
      mapAlertOverlay.classList.add('active');
      document.body.style.boxShadow = 'inset 0 0 120px rgba(255,0,0,0.25)';
      screenFlash.classList.remove('active');
      void screenFlash.offsetWidth;
      screenFlash.style.background = 'rgba(255,0,0,0.1)';
      screenFlash.classList.add('active');
      setTimeout(() => {
        mapAlertOverlay.classList.remove('active');
        document.body.style.boxShadow = 'none';
        screenFlash.style.background = 'rgba(255,30,30,0.06)';
      }, 4000);
      pushFeed('<span class="alert">[BREACH]</span> Security perimeter compromised ‚Äî Countermeasures engaged');
    }
  },
  '7': {
    name: 'SATELLITE UPLINK',
    action: () => {
      sfx.satellite();
      // Spawn events across the map
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          const loc = eventLocations[Math.floor(Math.random() * eventLocations.length)];
          mapEvents.push({
            type: 'intercept', color: [30,144,255], label: 'SAT SWEEP',
            duration: 200, icon: 'intercept',
            x: loc.x, y: loc.y, name: loc.name,
            age: 0, maxAge: 200, ringPhase: 0,
          });
        }, i * 300);
      }
      mapAlertTitle.textContent = 'üì° SATELLITE SWEEP';
      mapAlertDetail.textContent = 'OVERWATCH-SAT-3 ‚Äî FULL SPECTRUM SCAN INITIATED';
      mapAlertOverlay.classList.add('active');
      setTimeout(() => mapAlertOverlay.classList.remove('active'), 3000);
      pushFeed('<span class="info">[SAT-UPLINK]</span> OVERWATCH-SAT-3 full spectrum scan initiated');
    }
  },
  '8': {
    name: 'EXTRACTION',
    action: () => {
      sfx.confirm();
      mapAlertTitle.textContent = 'üü¢ EXTRACTION CONFIRMED';
      mapAlertDetail.textContent = 'PAPA ‚Äî HELICOPTER INBOUND ‚Äî ETA 4 MINUTES';
      mapAlertOverlay.classList.add('active');
      document.body.style.boxShadow = 'inset 0 0 60px rgba(0,230,118,0.15)';
      setTimeout(() => {
        mapAlertOverlay.classList.remove('active');
        document.body.style.boxShadow = 'none';
      }, 3500);
      pushFeed('<span class="highlight">[EXTRACTION]</span> Helicopter inbound ‚Äî PAPA extraction confirmed');
      for (let i = 0; i < 3; i++) {
        setTimeout(() => {
          mapEvents.push({
            type: 'extraction', color: [0,230,118], label: 'EXTRACTION ROUTE',
            duration: 250, icon: 'extraction',
            x: 0.48 + Math.random()*0.08, y: 0.20 + Math.random()*0.06, name: 'EN ROUTE',
            age: 0, maxAge: 250, ringPhase: 0,
          });
        }, i * 500);
      }
    }
  },
  '9': {
    name: 'COUNTDOWN',
    action: () => {
      let count = 10;
      mapAlertTitle.textContent = `‚è± COUNTDOWN: ${count}`;
      mapAlertDetail.textContent = 'DETONATION SEQUENCE INITIATED';
      mapAlertOverlay.classList.add('active');
      pushFeed('<span class="alert">[COUNTDOWN]</span> Detonation sequence initiated ‚Äî T-10 seconds');
      const interval = setInterval(() => {
        count--;
        sfx.countdown();
        if (count > 0) {
          mapAlertTitle.textContent = `‚è± COUNTDOWN: ${count}`;
          if (count <= 3) {
            mapAlertTitle.style.fontSize = '22px';
            document.body.style.boxShadow = `inset 0 0 ${120-count*30}px rgba(255,0,0,${0.15+count*0.05})`;
          }
        } else {
          clearInterval(interval);
          mapAlertTitle.style.fontSize = '';
          mapAlertTitle.textContent = 'üí• DETONATION';
          mapAlertDetail.textContent = '';
          sfx.explosion();
          // Big shake
          document.body.style.transform = 'translate(5px, -4px)';
          setTimeout(() => document.body.style.transform = 'translate(-5px, 4px)', 60);
          setTimeout(() => document.body.style.transform = 'translate(4px, 3px)', 120);
          setTimeout(() => document.body.style.transform = 'translate(-3px, -3px)', 180);
          setTimeout(() => document.body.style.transform = 'translate(2px, 1px)', 240);
          setTimeout(() => document.body.style.transform = 'none', 300);
          screenFlash.style.background = 'rgba(255,200,50,0.2)';
          screenFlash.classList.remove('active');
          void screenFlash.offsetWidth;
          screenFlash.classList.add('active');
          setTimeout(() => {
            mapAlertOverlay.classList.remove('active');
            document.body.style.boxShadow = 'none';
            screenFlash.style.background = 'rgba(255,30,30,0.06)';
          }, 2000);
        }
      }, 1000);
    }
  },
  '0': {
    name: 'SYSTEM SCAN',
    action: () => {
      sfx.scan();
      // Rapid feed lines
      const scanLines = [
        '<span class="info">[SYSTEM]</span> Initiating full diagnostic...',
        '<span class="info">[SYSTEM]</span> Network nodes: 47/47 ‚óè ONLINE',
        '<span class="info">[SYSTEM]</span> Encryption: AES-256-GCM ‚óè VERIFIED',
        '<span class="highlight">[SYSTEM]</span> Satellite link: OVERWATCH-3 ‚óè LOCKED',
        '<span class="highlight">[SYSTEM]</span> Field agents: 9 ACTIVE / 2 DARK / 1 OFFLINE',
        '<span class="highlight">[SYSTEM]</span> All systems nominal ‚óè ARGUS OPERATIONAL',
      ];
      scanLines.forEach((line, i) => {
        setTimeout(() => {
          pushFeed(line);
          sfx.countdown();
        }, i * 400);
      });
    }
  },
};

// Key hint overlay (shown briefly)
const keyHintDiv = document.createElement('div');
keyHintDiv.style.cssText = 'position:fixed;bottom:60px;left:50%;transform:translateX(-50%);font-family:"Orbitron",sans-serif;font-size:12px;letter-spacing:2px;color:rgba(30,144,255,0.8);z-index:10001;pointer-events:none;opacity:0;transition:opacity 0.3s;text-align:center;background:rgba(6,10,16,0.9);padding:8px 20px;border:1px solid rgba(30,144,255,0.3);';
document.body.appendChild(keyHintDiv);

// ============= CHAT INPUT =============
const commsInput = document.getElementById('commsInput');

// Auto-focus input when clicking anywhere
document.addEventListener('click', () => {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  commsInput.focus();
});
commsInput.focus();


// ---- AUTO-TYPE DIALOGUE POOL (100 lines) ----
const autoTypeMessages = [
  'Confirm visual on target. Moving to intercept position.',
  'PAPA, hold position. Overwatch has eyes on the compound.',
  'Relay encrypted packet to Station Vienna. Priority Alpha.',
  'Target vehicle heading NNW on E4 highway. Speed 110km/h.',
  'Request satellite reposition over grid 48-North 16-East.',
  'All units maintain radio silence until further notice.',
  'Cross-reference PROMETHEUS alias with Interpol Red Notice database.',
  'Drone feed shows 6 hostiles at the eastern perimeter.',
  'Switch to backup frequency. Primary channel may be compromised.',
  'Copy. Initiating dead drop protocol at coordinates 47.5N 19.0E.',
  'Agent 008 last known position: 52.5200N 13.4050E. Status unknown.',
  'Run biometric scan on the surveillance footage from CAM-17A.',
  'Extraction helicopter ETA 12 minutes. Secure the landing zone.',
  'Financial trace shows wire transfer to Cayman account ending 4491.',
  'Authorize use of electronic countermeasures in Sector 7.',
  'Confirm: the asset is BLUEBIRD. Codename unchanged.',
  'Dispatch counter-surveillance team to Hotel Sacher immediately.',
  'Target has changed vehicles. Now in black Mercedes, plate unknown.',
  'Intercepted burst transmission. Decryption in progress.',
  'PAPA reports shots fired near the old bridge. Requesting QRF.',
  'Pull up thermal imaging on the warehouse at Dock 14.',
  'Agent COBRA requests emergency extraction from Karachi safe house.',
  'Patch me through to the Director. This is Priority One.',
  'SIGINT confirms: meeting scheduled 2200 local at the opera house.',
  'All stations: threat level elevated to CRITICAL. Stay sharp.',
  'Uploading facial recognition data to ARGUS network now.',
  'Roger. Maintaining overwatch position on the rooftop.',
  'The informant says the shipment arrives at dawn. Harbour Gate 3.',
  'Negative. Do not engage until we have positive ID confirmation.',
  'Scramble the cyber team. Someone is probing our firewall.',
  'Task RAVEN with eyes on Moscow embassy. Report any movement.',
  'Deploy signal jamming on 14.223 MHz. That is their command freq.',
  'Debrief from FALCON confirms the Tangier cell is operational.',
  'I need a full workup on ERIK VOGT. Passport, travel, financials.',
  'PAPA, your tracker battery is critical. Conserve power.',
  'Confirmed kill on the surveillance drone. Origin unknown.',
  'Redirect SAT-3 to cover the Bosphorus strait. High priority.',
  'The minister wants a briefing in 30 minutes. Prepare the deck.',
  'Check the dead drop at Regent Park bench 7C. Sweep for devices.',
  'Hostile SIGINT detected on our secondary channel. Switching now.',
  'Agent GHOST has not reported in 96 hours. Initiate recovery protocol.',
  'Weapons cache located at 48.19N 16.38E. Requesting airstrike authorization.',
  'Negative on airstrike. Too close to civilian population. Send ground team.',
  'TECHOPS confirms: the cipher key rotates every 4 hours.',
  'Pull the CCTV archives from Vienna Hauptbahnhof. Last 72 hours.',
  'Asset reports PROMETHEUS acquired new identity documents in Belgrade.',
  'I have a clean shot. Awaiting authorization to proceed.',
  'Hold fire. We need him alive for interrogation.',
  'Counter-intel swept the embassy. Three bugs found and neutralized.',
  'Relay to Langley: Operation IRON BRIDGE is a go.',
  'Target entered the underground parking. Camera coverage is limited.',
  'Requesting additional field operatives for Berlin station.',
  'The double agent is feeding them false coordinates. Plan is working.',
  'Confirm receipt of the encrypted dossier. File ref: ALPHA-7749.',
  'Ground team in position at all four exits. Target is boxed in.',
  'Satellite shows heat signatures. 12 personnel inside the compound.',
  'Agent SPECTRE confirms Macau casino is the money laundering front.',
  'Divert QRF to coordinates 48.12N 16.22E. Shots fired.',
  'PAPA is 200 meters from the target. Maintaining visual contact.',
  'Run voice analysis on the intercepted phone call. Match to PROMETHEUS.',
  'Evacuate all non-essential personnel from Vienna station.',
  'The courier will be carrying a silver briefcase. Do not lose him.',
  'Intercepted email mentions a chemical agent. Alert HAZMAT teams.',
  'Negative contact on frequency 7. Switching to emergency backup.',
  'Confirm identity of individual at checkpoint BRAVO. Possible hostile.',
  'TECHOPS: deploy the tracking nano-dust at the hotel entrance.',
  'Target made a phone call. Duration 47 seconds. Triangulating.',
  'All units: NIGHTFALL protocol is now active. Execute phase 2.',
  'Sniper team EAGLE is in position on the bell tower. Ready.',
  'Maritime patrol reports suspicious vessel 12 nautical miles offshore.',
  'The informant is getting nervous. Arrange a new safe house.',
  'I am reading anomalous radiation levels at the target building.',
  'Patch the drone feed through to the main display. Top priority.',
  'COBRA team: breach on my signal. Flashbangs first.',
  'Cyber division traced the hack to a server farm in Pyongyang.',
  'Asset ORACLE has decoded the latest PROMETHEUS communique.',
  'We have a mole. Restrict all operations to need-to-know basis.',
  'Target is using the subway system. Deploy teams to all exits.',
  'Requesting clearance to access the NSA PRISM database.',
  'Agent TREVELYAN signal lost 6 hours ago over the Black Sea.',
  'The arms dealer will be at the charity gala tonight. Get me an invite.',
  'Forensics confirms: the bomb components match the Istanbul device.',
  'PAPA, there is a sniper on the roof at your 2 o\'clock. Take cover.',
  'All comms encrypted. Switching to quantum-resistant protocol.',
  'Satellite imagery confirms 4 mobile launchers at the base.',
  'We need to move the timeline up. Execute operation at 0300.',
  'Agent in place at the airport. Watching Gate B14 for ERIK VOGT.',
  'HUMINT source says the meeting location has changed. Stand by.',
  'The package is en route via diplomatic pouch. ETA 6 hours.',
  'Sweep team found a listening device in the ambassador residence.',
  'Target acquired facial recognition match: 97.2% confidence.',
  'All field teams report in. I need status updates in 5 minutes.',
  'Confirmed: PROMETHEUS has left the country. Last seen at border crossing.',
  'The cell in Ankara is planning something big. We need more intel.',
  'Emergency broadcast: Agent down at Tangier. Medevac requested.',
  'Uploading new threat assessment to all field terminals now.',
  'Run a background check on the new embassy attache. Something feels wrong.',
  'PAPA, package secured. Heading to extraction point Charlie.',
  'Intercepted chatter mentions a second target. Codename ATLAS.',
  'Deploy EMP device on my mark. All electronics will go dark.',
  'Final confirmation received from the Director. Mission is authorized.',
];

// ---- AUTO-TYPE STATE ----
let autoTypeEnabled = true;
let autoTypeCurrent = '';
let autoTypePos = 0;

function pickAutoTypeMessage() {
  autoTypeCurrent = autoTypeMessages[Math.floor(Math.random() * autoTypeMessages.length)];
  autoTypePos = 0;
}

// ---- REPLY POOL ----
const replyPool = [
  { src: 'ORACLE', msg: 'Copy that. Processing your request.' },
  { src: 'DIRECTOR', msg: 'Acknowledged. Proceed with caution.' },
  { src: 'AEGIS', msg: 'Berlin team copies. Awaiting green light.' },
  { src: 'ORACLE', msg: 'Understood. Updating ARGUS database.' },
  { src: 'DIRECTOR', msg: 'Noted. Keep this channel secure.' },
  { src: 'PAPA', msg: 'Received. Maintaining radio silence.' },
  { src: 'PHOENIX', msg: 'Istanbul confirms. Adjusting operational parameters.' },
  { src: 'ORACLE', msg: 'Running analysis now. Stand by for results.' },
  { src: 'DIRECTOR', msg: 'Very well. I\'ll brief the minister.' },
  { src: 'SPECTRE', msg: 'Macau station copies. Eyes only.' },
  { src: 'PAPA', msg: 'Roger. Moving to secondary position now.' },
  { src: 'ORACLE', msg: 'Satellite feed updated. Check main display.' },
  { src: 'FALCON', msg: 'Tangier team in position. Ready on your mark.' },
  { src: 'DIRECTOR', msg: 'Approved. Execute at your discretion.' },
  { src: 'COBRA', msg: 'Karachi station acknowledges. Standing by.' },
  { src: 'RAVEN', msg: 'Moscow intel confirms. Routing to you now.' },
  { src: 'ORACLE', msg: 'Decryption complete. Sending results now.' },
  { src: 'SHADOW', msg: 'Tehran team standing by. Awaiting orders.' },
  { src: 'DIRECTOR', msg: 'The committee has been informed. Carry on.' },
  { src: 'PAPA', msg: 'Copy. Going dark for 20 minutes.' },
];

let operatorName = 'OPERATOR';

function sendOperatorMsg(msg) {
  const ts = fmtTs();
  const line = document.createElement('div');
  line.innerHTML = `<span class="ts">${ts}</span> <span class="src" style="color:var(--green)">${escapeHtml(operatorName)}</span>: <span class="msg" style="color:#e8f0ff">${escapeHtml(msg)}</span>`;
  commsEl.appendChild(line);
  while (commsEl.children.length > 30) commsEl.removeChild(commsEl.firstChild);
  commsEl.scrollTop = commsEl.scrollHeight;
  playTone(800, 0.06, 'sine', 0.08);
  setTimeout(() => playTone(1200, 0.08, 'sine', 0.06), 60);
  broadcastToPeers({type:'chat', name: operatorName, text: msg});

  // Auto-reply
  setTimeout(() => {
    const reply = replyPool[Math.floor(Math.random() * replyPool.length)];
    const rts = fmtTs();
    const rline = document.createElement('div');
    const ra = agents.find(a => a.name === reply.src);
    const rColor = ra ? getAgentColor(ra.status).hex : '';
    const rStyle = rColor ? ` style="color:${rColor}"` : '';
    rline.innerHTML = `<span class="ts">${rts}</span> <span class="src"${rStyle}>${agentLabel(reply.src)}</span>: <span class="msg">${reply.msg}</span>`;
    commsEl.appendChild(rline);
    while (commsEl.children.length > 30) commsEl.removeChild(commsEl.firstChild);
    commsEl.scrollTop = commsEl.scrollHeight;
    sfx.comms();
    focusAgent(reply.src);
  }, 1500 + Math.random() * 2500);
}

// ============= SLASH COMMAND HINT =============
const cmdHint = document.getElementById('cmdHint');

let cmdHintIdx = -1;

function getVisibleHintItems() {
  return [...cmdHint.querySelectorAll('.cmd-hint-item')].filter(i => i.style.display !== 'none');
}

function updateHintSelection() {
  const items = getVisibleHintItems();
  items.forEach((item, i) => item.classList.toggle('cmd-selected', i === cmdHintIdx));
}

function showCmdHint() {
  cmdHint.classList.add('visible');
  cmdHintIdx = -1;
  updateHintSelection();
}

function hideCmdHint() {
  cmdHint.classList.remove('visible');
  cmdHintIdx = -1;
  updateHintSelection();
}

function setAutoType(enabled) {
  autoTypeEnabled = enabled;
  autoTypeCurrent = '';
  autoTypePos = 0;
  commsInput.value = '';
  commsInput.placeholder = autoTypeEnabled ? 'Type anything ‚Äî auto-fill active  [/help]' : 'Type message or /command  [/help]';
  keyHintDiv.textContent = autoTypeEnabled ? 'AUTO-TYPE ON' : 'AUTO-TYPE OFF ‚Äî MANUAL MODE';
  keyHintDiv.style.opacity = '1';
  clearTimeout(keyHintDiv._timer);
  keyHintDiv._timer = setTimeout(() => keyHintDiv.style.opacity = '0', 2000);
  sfx.confirm();
}

// Parse toggle arg: returns true/false or null (= flip)
function parseToggle(arg, current) {
  if (!arg) return !current;
  const v = arg.toLowerCase();
  if (['on','true','1','yes'].includes(v)) return true;
  if (['off','false','0','no'].includes(v)) return false;
  return !current;
}

function showHint(text) {
  keyHintDiv.textContent = text;
  keyHintDiv.style.opacity = '1';
  clearTimeout(keyHintDiv._timer);
  keyHintDiv._timer = setTimeout(() => keyHintDiv.style.opacity = '0', 1500);
}

function handleSlashCommand(cmd) {
  hideCmdHint();
  commsInput.value = '';

  // Split command and argument
  const parts = cmd.match(/^(\/\S+)\s*(.*)$/);
  if (!parts) return false;
  const base = parts[1].toLowerCase();
  const arg = parts[2] || '';

  if (base === '/auto-type') {
    setAutoType(parseToggle(arg, autoTypeEnabled));
    return true;
  }

  if (base === '/auto-event') {
    autoEventsEnabled = parseToggle(arg, autoEventsEnabled);
    showHint(autoEventsEnabled ? 'AUTO-EVENT ON' : 'AUTO-EVENT OFF');
    pushFeed(autoEventsEnabled
      ? '<span class="highlight">[SYSTEM]</span> Auto events ENABLED'
      : '<span class="warn">[SYSTEM]</span> Auto events DISABLED');
    return true;
  }

  if (base === '/sound') {
    isMuted = !parseToggle(arg, !isMuted);
    showHint(isMuted ? 'SOUND OFF' : 'SOUND ON');
    return true;
  }

  if (base === '/auto-comms') {
    dummyCommsEnabled = parseToggle(arg, dummyCommsEnabled);
    showHint(dummyCommsEnabled ? 'DUMMY COMMS ON' : 'DUMMY COMMS OFF');
    return true;
  }


  if (base === '/name' && arg) {
    operatorName = arg.trim().toUpperCase();
    document.querySelector('.comms-input-prefix').textContent = operatorName + ' >';
    showHint(`CALLSIGN: ${operatorName}`);
    broadcastToPeers({type:'name', name: operatorName});
    return true;
  }

  // /1 ~ /0 ‚Üí trigger keyActions
  const numMatch = base.match(/^\/([0-9])$/);
  if (numMatch && keyActions[numMatch[1]]) {
    const action = keyActions[numMatch[1]];
    action.action();
    broadcastToPeers({type:'trigger', key: numMatch[1]});
    showHint(`/${numMatch[1]} ‚Äî ${action.name}`);
    return true;
  }

  // ---- P2P ----
  if (base === '/link') {
    const a = arg.trim().toLowerCase();
    if (/^\d{6}$/.test(a)) {
      // /link <code> ‚Üí connect to peer
      if (maxSlots === 0) maxSlots = 1;
      updatePeerStatus();
      pushFeed(`<span class="info">[P2P]</span> Connecting to ${a}...`);
      const conn = peer.connect('spy-' + a);
      registerConn(conn);
    } else if (a === 'off' || (!a && (maxSlots > 0 || peerConns.length > 0))) {
      // /link off or toggle off
      peerConns.forEach(c => { removeLinkedAgent(c); c.close(); });
      peerConns = [];
      maxSlots = 0;
      updatePeerStatus();
      pushFeed('<span class="warn">[P2P]</span> Link closed');
      showHint('LINK OFF');
    } else {
      // /link on or toggle on
      if (maxSlots === 0) maxSlots = 1;
      updatePeerStatus();
      pushFeed(`<span class="info">[P2P]</span> Link open ‚Äî Room: <span style="color:var(--amber)">${peerCode}</span>`);
      showRoomCode();
    }
    return true;
  }

  if (base === '/link-slot') {
    const n = parseInt(arg);
    if (isNaN(n) || n < 1) {
      pushFeed('<span class="warn">[P2P]</span> Usage: /link-slot &lt;number&gt; (min 1)');
      return true;
    }
    maxSlots = n;
    updatePeerStatus();
    pushFeed(`<span class="info">[P2P]</span> Max connections set to ${maxSlots}`);
    showHint(`SLOTS: ${maxSlots}`);
    return true;
  }

  return false;
}

// Send message on Enter, auto-type on any other key
commsInput.addEventListener('keydown', (e) => {
  const val = commsInput.value;

  // Arrow key navigation in command hint overlay
  if (cmdHint.classList.contains('visible') && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) {
    e.preventDefault();
    const items = getVisibleHintItems();
    if (items.length === 0) return;
    if (e.key === 'ArrowDown') {
      cmdHintIdx = cmdHintIdx < items.length - 1 ? cmdHintIdx + 1 : 0;
    } else {
      cmdHintIdx = cmdHintIdx > 0 ? cmdHintIdx - 1 : items.length - 1;
    }
    updateHintSelection();
    // Fill input with selected command
    const key = items[cmdHintIdx].querySelector('.cmd-key');
    if (key) commsInput.value = key.textContent;
    return;
  }

  if (e.key === 'Enter') {
    e.preventDefault();
    // If hint is visible and an item is selected, use it
    if (cmdHint.classList.contains('visible') && cmdHintIdx >= 0) {
      const items = getVisibleHintItems();
      const sel = items[cmdHintIdx];
      if (sel) {
        const key = sel.querySelector('.cmd-key').textContent;
        commsInput.value = key;
        hideCmdHint();
        // Commands that need args: don't auto-submit, let user type the arg
        if (['/name','/slots','/connect'].includes(key)) {
          commsInput.value = key + ' ';
          return;
        }
      }
    }
    const trimmed = val.trim();
    if (!trimmed) return;

    // Check slash commands first
    if (trimmed.startsWith('/')) {
      if (handleSlashCommand(trimmed)) return;
    }

    // Normal send
    commsInput.value = '';
    autoTypeCurrent = '';
    autoTypePos = 0;
    hideCmdHint();
    sendOperatorMsg(trimmed);
    return;
  }

  // Ctrl+C: turn off auto-type
  if (e.ctrlKey && e.key === 'c') {
    if (autoTypeEnabled) {
      e.preventDefault();
      setAutoType(false);
      hideCmdHint();
      return;
    }
  }

  // Escape: clear input & hide hint
  if (e.key === 'Escape') {
    e.preventDefault();
    commsInput.value = '';
    autoTypeCurrent = '';
    autoTypePos = 0;
    hideCmdHint();
    return;
  }

  // If typing a slash command in manual mode (or slash mode)
  if (!autoTypeEnabled || val === '' || val.startsWith('/')) {
    // Let "/" through naturally in manual mode
    if (e.key === '/' && val === '') {
      // Will become "/" after default handler ‚Äî show hint on next tick
      setTimeout(() => {
        if (commsInput.value === '/') showCmdHint();
      }, 0);
      // Disable auto-type temporarily for command entry
      if (autoTypeEnabled) {
        e.preventDefault();
        commsInput.value = '/';
        showCmdHint();
      }
      playTone(3000 + Math.random()*1000, 0.02, 'sine', 0.03);
      return;
    }

    // If we're in slash-command entry mode (value starts with /)
    if (val.startsWith('/')) {
      // Allow normal typing for the command
      if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
        playTone(3000 + Math.random()*1000, 0.02, 'sine', 0.03);
      }
      // Update hint highlight on next tick
      setTimeout(() => {
        const cv = commsInput.value;
        if (cv.startsWith('/') && cv.length > 1) {
          // Filter matching commands
          const items = cmdHint.querySelectorAll('.cmd-hint-item');
          let anyMatch = false;
          items.forEach(item => {
            const key = item.querySelector('.cmd-key').textContent;
            if (key.startsWith(cv)) {
              item.style.display = '';
              anyMatch = true;
            } else {
              item.style.display = 'none';
            }
          });
          if (anyMatch) showCmdHint(); else hideCmdHint();
        } else if (cv === '/') {
          cmdHint.querySelectorAll('.cmd-hint-item').forEach(i => i.style.display = '');
          showCmdHint();
        } else {
          hideCmdHint();
        }
      }, 0);

      if (e.key === 'Backspace') {
        setTimeout(() => {
          if (commsInput.value === '') hideCmdHint();
          else if (commsInput.value === '/') {
            cmdHint.querySelectorAll('.cmd-hint-item').forEach(i => i.style.display = '');
            showCmdHint();
          }
        }, 0);
      }
      return;
    }
  }

  if (autoTypeEnabled) {
    // Auto-type: any printable key advances the pre-selected message
    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
      e.preventDefault();
      playTone(3000 + Math.random()*1000, 0.02, 'sine', 0.03);

      if (!autoTypeCurrent || autoTypePos >= autoTypeCurrent.length) {
        pickAutoTypeMessage();
      }

      autoTypePos++;
      commsInput.value = autoTypeCurrent.slice(0, autoTypePos);

      // Auto-send when message is complete
      if (autoTypePos >= autoTypeCurrent.length) {
        setTimeout(() => {
          const msg = commsInput.value.trim();
          if (msg) {
            commsInput.value = '';
            autoTypeCurrent = '';
            autoTypePos = 0;
            sendOperatorMsg(msg);
          }
        }, 300);
      }
    }

    // Backspace removes one auto-typed char
    if (e.key === 'Backspace') {
      e.preventDefault();
      if (autoTypePos > 0) {
        autoTypePos--;
        commsInput.value = autoTypeCurrent.slice(0, autoTypePos);
      }
      if (autoTypePos === 0) {
        autoTypeCurrent = '';
      }
    }
  } else {
    // Manual mode: normal typing with keystroke sound
    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
      playTone(3000 + Math.random()*1000, 0.02, 'sine', 0.03);
    }
  }
});

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============= CTRL + NUMBER TRIGGERS =============
document.addEventListener('keydown', (e) => {
  if (audioCtx.state === 'suspended') audioCtx.resume();

  // Only fire triggers on Ctrl + number (when not in input slash mode)
  if (e.ctrlKey && keyActions[e.key]) {
    e.preventDefault();
    const action = keyActions[e.key];
    action.action();
    broadcastToPeers({type:'trigger', key: e.key});
    keyHintDiv.textContent = `[Ctrl+${e.key}] ${action.name}`;
    keyHintDiv.style.opacity = '1';
    clearTimeout(keyHintDiv._timer);
    keyHintDiv._timer = setTimeout(() => keyHintDiv.style.opacity = '0', 1500);
  }
});

// ============= PEERJS P2P =============
let peerCode = String(Math.floor(100000 + Math.random() * 900000));
let peer = null;
let peerConns = [];
let maxSlots = 0;
let isRemoteAction = false;

function updatePeerStatus() {
  const el = document.getElementById('peerStatus');
  const linked = peerConns.length;
  if (maxSlots === 0 && linked === 0) {
    el.innerHTML = `<span style="color:var(--text-dim)">‚óã LINK OFF</span>`;
  } else {
    const statusDot = linked > 0 ? '‚óè' : '‚óã';
    const statusText = linked > 0 ? `LINKED (${linked})` : 'WAITING';
    const statusColor = linked > 0 ? 'var(--green)' : 'var(--amber)';
    el.innerHTML = `ROOM: <span style="color:var(--amber)">${peerCode}</span> &nbsp; SLOTS: ${linked}/${maxSlots} &nbsp; <span style="color:${statusColor}">${statusDot} ${statusText}</span>`;
  }
}

function showRoomCode() {
  const overlay = document.getElementById('roomCodeOverlay');
  document.getElementById('roomCodeDisplay').textContent = peerCode;
  overlay.style.display = 'flex';
  const btn = document.getElementById('roomCodeOkBtn');
  function dismiss() {
    overlay.style.display = 'none';
    btn.removeEventListener('click', dismiss);
  }
  btn.addEventListener('click', dismiss);
  sfx.confirm();
}

function showPeerConfirm(peerId) {
  return new Promise((resolve) => {
    const overlay = document.getElementById('peerConfirmOverlay');
    document.getElementById('peerConfirmId').textContent = peerId;
    overlay.style.display = 'flex';
    const acceptBtn = document.getElementById('peerAcceptBtn');
    const rejectBtn = document.getElementById('peerRejectBtn');
    function cleanup() {
      overlay.style.display = 'none';
      acceptBtn.removeEventListener('click', onAccept);
      rejectBtn.removeEventListener('click', onReject);
    }
    function onAccept() { cleanup(); resolve(true); }
    function onReject() { cleanup(); resolve(false); }
    acceptBtn.addEventListener('click', onAccept);
    rejectBtn.addEventListener('click', onReject);
    sfx.alert();
  });
}

function addLinkedAgent(conn) {
  const code = conn.peer.replace('spy-', '');
  const agent = {
    code: code, name: code, loc: 'LINKED', status: 'active', role: 'LINKED PEER',
    x: 0.30 + Math.random() * 0.35, y: 0.20 + Math.random() * 0.25,
    linked: true, _conn: conn,
  };
  agents.push(agent);
  rebuildTrackingPoints();
  renderAgentList();
  focusAgent(code);
}

function removeLinkedAgent(conn) {
  const idx = agents.findIndex(a => a._conn === conn);
  if (idx >= 0) {
    agents.splice(idx, 1);
    rebuildTrackingPoints();
    renderAgentList();
  }
}

function updateLinkedAgentName(conn, name) {
  const agent = agents.find(a => a._conn === conn);
  if (agent && agent.name !== name) {
    agent.name = name;
    rebuildTrackingPoints();
    renderAgentList();
  }
}

function registerConn(conn) {
  conn.on('open', () => {
    if (!peerConns.includes(conn)) {
      peerConns.push(conn);
      pushFeed(`<span class="highlight">[P2P]</span> Link established ‚Äî Peer ${conn.peer.replace('spy-','')}`);
      addLinkedAgent(conn);
    }
    updatePeerStatus();
  });
  conn.on('data', (data) => handlePeerData(data, conn));
  conn.on('close', () => {
    peerConns = peerConns.filter(c => c !== conn);
    removeLinkedAgent(conn);
    updatePeerStatus();
    pushFeed(`<span class="warn">[P2P]</span> Peer disconnected ‚Äî ${conn.peer.replace('spy-','')}`);
  });
  conn.on('error', (err) => {
    pushFeed(`<span class="alert">[P2P]</span> Connection error: ${err.type || err}`);
  });
  if (conn.open) {
    if (!peerConns.includes(conn)) {
      peerConns.push(conn);
      pushFeed(`<span class="highlight">[P2P]</span> Link established ‚Äî Peer ${conn.peer.replace('spy-','')}`);
      addLinkedAgent(conn);
    }
    updatePeerStatus();
  }
}

function handlePeerData(data, conn) {
  if (!data || !data.type) return;
  isRemoteAction = true;
  try {
    switch (data.type) {
      case 'chat': {
        const line = document.createElement('div');
        const name = data.name || 'REMOTE';
        line.innerHTML = `<span class="ts">${fmtTs()}</span> <span class="src" style="color:var(--accent)">${escapeHtml(agentLabel(name))}</span>: <span class="msg" style="color:#e8f0ff">${escapeHtml(data.text)}</span>`;
        commsEl.appendChild(line);
        while (commsEl.children.length > 30) commsEl.removeChild(commsEl.firstChild);
        commsEl.scrollTop = commsEl.scrollHeight;
        sfx.comms();
        focusAgent(name);
        break;
      }
      case 'trigger': {
        if (data.key && keyActions[data.key]) {
          keyActions[data.key].action();
          showHint(`REMOTE /${data.key} ‚Äî ${keyActions[data.key].name}`);
        }
        break;
      }
      case 'name': {
        if (data.name) {
          updateLinkedAgentName(conn, data.name.toUpperCase());
          pushFeed(`<span class="info">[P2P]</span> Peer changed callsign to <span style="color:var(--accent)">${escapeHtml(data.name)}</span>`);
        }
        break;
      }
    }
  } finally {
    isRemoteAction = false;
  }
}

function broadcastToPeers(msg) {
  if (isRemoteAction) return;
  peerConns.forEach(conn => {
    if (conn.open) conn.send(msg);
  });
}

function initPeer() {
  if (typeof Peer === 'undefined') {
    pushFeed('<span class="alert">[P2P]</span> PeerJS not loaded ‚Äî P2P disabled');
    return;
  }
  peer = new Peer('spy-' + peerCode);
  peer.on('open', () => {
    pushFeed(`<span class="info">[P2P]</span> Peer initialized ‚Äî Room: <span style="color:var(--amber)">${peerCode}</span>`);
    updatePeerStatus();
  });
  peer.on('connection', (conn) => {
    if (peerConns.length >= maxSlots) {
      conn.close();
      pushFeed('<span class="warn">[P2P]</span> Incoming connection rejected ‚Äî slots full');
      return;
    }
    showPeerConfirm(conn.peer.replace('spy-', '')).then(accepted => {
      if (accepted) {
        registerConn(conn);
      } else {
        conn.close();
        pushFeed('<span class="warn">[P2P]</span> Connection rejected by operator');
      }
    });
  });
  peer.on('error', (err) => {
    pushFeed(`<span class="alert">[P2P]</span> Peer error: ${err.type}`);
    if (err.type === 'unavailable-id') {
      peerCode = String(Math.floor(100000 + Math.random() * 900000));
      pushFeed(`<span class="info">[P2P]</span> Regenerated code: ${peerCode} ‚Äî retrying...`);
      setTimeout(initPeer, 1000);
    }
  });
}
initPeer();
</script>
</body>
</html>
